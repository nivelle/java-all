ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---
## é—®é¢˜ï¼ˆé€‰è‡ªç»å…¸é¢è¯•é¢˜ï¼‰
1. å‡ ç§å¸¸è§çš„çº¿ç¨‹æ± æœ‰å“ªäº›ï¼Œä»¥åŠä»–ä»¬çš„ä½¿ç”¨åœºæ™¯
2. çº¿ç¨‹æ± éƒ½æœ‰å“ªå‡ ç§å·¥ä½œé˜Ÿåˆ—
3. ç®€å•çš„æè¿°ä¸€ä¸‹çº¿ç¨‹æ± çš„å·¥ä½œåŸç†

## ç®€ä»‹
**çº¿ç¨‹æ± ** æ˜¯ä¸€ç§çº¿ç¨‹ä½¿ç”¨æ¨¡å¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§æ± åŒ–æŠ€æœ¯ã€‚åœ¨javaä¸­ï¼Œç±»ä¼¼çš„æ± åŒ–æŠ€æœ¯æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚jvmçš„Stringå¸¸é‡æ± ï¼Œæ•°æ®åº“è¿æ¥æ± ã€‚
å¦‚æœæŠŠæ­¤é€»è¾‘è¿›è¡Œæ‹“å±•ï¼Œç”šè‡³è¿å•ä¾‹æ¨¡å¼æˆ–è€…redisç¼“å­˜ä¹Ÿç®—æ˜¯ä¸€ç§æ± åŒ–æŠ€æœ¯ã€‚è€Œæ± åŒ–æŠ€æœ¯æœ€åˆçš„ç›®çš„ï¼Œå°±æ˜¯å‡å°‘è®¡ç®—æœºçš„èµ„æºæ¶ˆè€—ã€‚

JDKä¸­çš„å…³äº**å¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶**ä¸»è¦æœ‰ä¸¤ä¸ª Executoræ¡†æ¶ å’Œ fork-joinæ¡†æ¶ æœ¬ç« å…ˆæ‹¿Executoræ¡†æ¶å¼€åˆ€ã€‚

å¯¹äºExecutoræ¡†æ¶è€Œè¨€ï¼Œæœ€æ ¸å¿ƒçš„å°±æ˜¯ThreadPoolExecutorç±»ã€‚JDKæä¾›çš„å››å¤§é»˜è®¤çº¿ç¨‹æ± å°±æ˜¯ç”±æ­¤ç±»æä¾›æ”¯æŒã€‚

## ä¸€ä¸ªçº¿ç¨‹æ± çš„å°ä¾‹å­
```java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class TestThreadPool {

    public static void main(String[] args) {
        //åˆå§‹åŒ–ThreadPoolExecutorç±»ï¼Œè¿™é‡Œç»™ThreadPoolExecutorç±»æä¾›å¾ˆå¤šå¾ˆå¤šå‚æ•°
        ThreadPoolExecutor executor = new ThreadPoolExecutor(5, 10, 200, TimeUnit.MILLISECONDS,
                new ArrayBlockingQueue<Runnable>(5));

        for(int i=0;i<12;i++){
            //å®šä¹‰äº†ä¸€ä¸ªä»»åŠ¡
            Task task = new Task(i);
            //å¾€è¿™ä¸ªæ± è¿›è¡Œæäº¤ä»»åŠ¡
            executor.execute(task);
            //æ‰“å°ä¸€äº›çº¿ç¨‹æ± çš„ä¿¡æ¯ï¼Œå°±å•çº¯çš„æŸ¥çœ‹ä¸€ä¸‹
            System.out.println("çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ç›®ï¼š"+executor.getPoolSize()+"ï¼Œé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°ç›®ï¼š"+ executor.getQueue().size()+"ï¼Œå·²æ‰§è¡Œçš„ä»»åŠ¡æ•°ç›®ï¼š"+executor.getCompletedTaskCount());
        }
        //å…³é—­çº¿ç¨‹æ± ï¼Œä¸å†æ¥å—submit
        executor.shutdown();
    }
}


class Task implements Runnable {
    private int num;

    public Task(int num) {
        this.num = num;
    }
    @Override
    public void run() {
        System.out.println("æ­£åœ¨æ‰§è¡Œtask "+num);
        try {
            Thread.currentThread().sleep(4000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("task "+num+"æ‰§è¡Œå®Œæ¯•");
    }
}
```

ä»è¿™ä¸ªæœ€åŸºç¡€çš„åœºæ™¯ç±»å¯ä»¥çœ‹å‡ºï¼Œçº¿ç¨‹æ± çš„ä¸€èˆ¬è¿ä½œæ–¹å¼æœ‰

1. åˆå§‹åŒ–çº¿ç¨‹æ± ï¼Œé€šè¿‡å‚æ•°é…ç½®çº¿ç¨‹æ± çš„å„ç§è¡Œä¸º
2. å¾€çº¿ç¨‹æ± å†…æäº¤task
3. å…³é—­çº¿ç¨‹æ± 

é‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¸€æ­¥ä¸€æ­¥çš„è¿›å…¥åˆ°ThreadPoolExecutorå†…éƒ¨æŸ¥çœ‹åˆ°åº•è¿™ä¸ªç±»æ˜¯æ€ä¹ˆè¿ä½œçš„

## ä¹‹åçš„å°èŠ‚çš„ç›®å½•å¤§çº²

1. ThreadPoolExecutorçš„ç»§æ‰¿å…³ç³»å›¾ï¼Œé‡è¦çˆ¶ç±»ï¼Œæ¥å£çš„å…³ç³»ï¼Œä¸€äº›é‡è¦æ–¹æ³•
2. ThreadPoolExecutorç±»çš„é‡è¦field
       + çº¿ç¨‹æ± çš„çŠ¶æ€ç›¸å…³field
       + çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹æ³•ç›¸å…³çš„æ ¸å¿ƒfield
       + çº¿ç¨‹æ± çš„è¾…åŠ©æ€§æ”¯æŒfieldä¸inner class
3. ThreadPoolExecutorç±»æ„é€ æ–¹æ³•
4. ThreadPoolExecutorç±»çš„æ ¸å¿ƒæ–¹æ³•(æ ¸å¿ƒé€»è¾‘)
       + çº¿ç¨‹æ± çš„çº¿ç¨‹æäº¤ execute()
       + çº¿ç¨‹æ± å†…å·¥ä½œçº¿ç¨‹åˆå§‹åŒ– addWorker()
       + å·¥ä½œçº¿ç¨‹ Workerå†…éƒ¨ç±»
       + å·¥ä½œçº¿ç¨‹è¿è¡Œ runWorker()
       + ä»é˜Ÿåˆ—å†…è·å¾—task getTask()
       + å…³é—­å·¥ä½œçº¿ç¨‹ processWorkerExit()
5. çº¿ç¨‹æ± çš„å…³é—­
6. ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—
7. æ‹’ç»ç­–ç•¥
8. ThreadPoolExecutorç±»å’ŒJDKæä¾›çš„å››ä¸ªçº¿ç¨‹æ± å…³ç³»

## 1. ThreadPoolExecutorçš„ç»§æ‰¿å…³ç³»
![ThreadPoolExecutorçš„ç»§æ‰¿å…³ç³»å›¾](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/1.1%E7%BB%A7%E6%89%BF%E5%9B%BE.png)

ä»å›¾å†…å¯ä»¥å¤§è‡´çŸ¥é“è¿™æ ·çš„ç»§æ‰¿å…³ç³» :

1. Executoræ˜¯ä¸€ä¸ªé¡¶å±‚æ¥å£ï¼Œæ‰“å¼€è¿™ä¸ªæ¥å£åå‘ç°åªæœ‰ä¸€ä¸ªæ–¹æ³•,æ­¤æ–¹æ³•å°±æ˜¯ç”¨æ¥æ‰§è¡Œä¼ è¿›å»çš„ä»»åŠ¡çš„
```java
public interface Executor {

    /**
     * 1. æ‰§è¡Œç»™å®šçš„æŒ‡ä»¤(Runnable å®ç°ç±»)
     * 2. æ­¤æŒ‡ä»¤å°†ä¼šåœ¨æ–°å¼€çº¿ç¨‹å†… æˆ– çº¿ç¨‹æ± å†… æˆ– å¸¦æœ‰è¿”å›çš„çº¿ç¨‹å†…æ‰§è¡Œ
     */
    void execute(Runnable command);
}
```
2. æ¥ä¸‹æ¥ExecutorServiceæ¥å£ç»§æ‰¿äº†Executoræ¥å£ï¼Œæ‰“å¼€å¹¶æ‘˜å–ä¸€éƒ¨åˆ†é‡è¦çš„æ–¹æ³•
```java
public interface ExecutorService extends Executor {
    // çº¿ç¨‹æ± å…³é—­ï¼Œçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å°±éšå®ƒå»
    void shutdown();
    
    //ç«‹åˆ»åœæ­¢ï¼é©¬ä¸Šï¼æ­£åœ¨æ‰§è¡Œçš„ç»™æˆ‘ç«‹é©¬åœï¼é‚£äº›ä¸ªæ²¡æ‰§è¡Œçš„è¿”å›æ¥
    List<Runnable> shutdownNow();
    
    //åˆ¤æ–­çº¿ç¨‹æ± æ˜¯ä¸æ˜¯è¢«åœäº†
    boolean isShutdown();

    //åˆ¤æ–­å…³é—­ï¼ˆè°ƒç”¨shutdownæ–¹æ³•ä¹‹åï¼‰çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹æ˜¯ä¸æ˜¯æ‰§è¡Œå®Œäº†
    boolean isTerminated();

    //è°ƒç”¨æ­¤æ–¹æ³•ä¹‹åå°±ä¸€ç›´ç­‰å¾…ç€çº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹æ‰§è¡Œå®Œäº†ä¹‹åï¼Œæ‰èƒ½ç»§ç»­ï¼Œä¸¤ä¸ªå‚æ•°æ§åˆ¶ç­‰å¾…çš„è¡Œä¸º
    boolean awaitTermination(long timeout, TimeUnit unit)
        throws InterruptedException;

     //å¥½é‡è¦å¥½é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨æ¥æäº¤æœ‰è¿”å›å€¼çš„çº¿ç¨‹
    <T> Future<T> submit(Callable<T> task);

    //æäº¤ä¸€ä¸ªçº¿ç¨‹ï¼ŒæŒ‡å®šä¸€ä¸ªç»“æœï¼Œå½“çº¿ç¨‹å®Œæˆçš„æ—¶å€™è¿”å›è‡ªå®šä¹‰çš„ç»“æœ
    //ç›¸å½“äºsubmit(Callable<T> task) çš„å¦å¤–ä¸€ç§å®ç°
    <T> Future<T> submit(Runnable task, T result);

    //æäº¤ä¸€ä¸ªrunnable çš„çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œäº†å°±è¿”å›null(Future.get()ä¹‹åè¿”å›)
    //æ˜¯ä¸æ˜¯è§‰å¾—æ²¡å•¥æ„ä¹‰~~æ„ä¹‰å½“ç„¶æœ‰
    //è¿”å›çš„æ˜¯ä¸€ä¸ªFutureï¼Œå½“è°ƒç”¨get(),ä»£ç å°±ä¼šå¡åœ¨é‚£ï¼Œç­‰ç€è¿”å›
    //è¿”å›çš„å³æ˜¯æ˜¯null,æˆ‘ä¹Ÿä¸careï¼Œç›®çš„åªæœ‰â€œæˆ‘çŸ¥é“è¿™ä¸ªä»»åŠ¡å·²ç»ç»“æŸäº†ï¼Œå¯ä»¥å¼€å§‹ä¸‹é¢çš„äº‹æƒ…äº†â€
    Future<?> submit(Runnable task);

    //ç›¸å½“äºæ‰¹é‡çš„submit(Callable<T> task)æ–¹æ³•ï¼Œä¸€å£æ°”æŠŠæƒ³æ‰§è¡Œçš„callable taskä¸¢è¿›çº¿ç¨‹æ± é‡Œé¢
    <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks)
        throws InterruptedException;

    //åœ¨æ‰¹é‡æäº¤çš„æ–¹æ³•ä¸Šå¢åŠ æ—¶é—´ç›¸å…³çš„å‚æ•°
    //å¦‚æœè¶…æ—¶ï¼Œé‚£ä¹ˆlisté‡Œé¢çš„æŸä¸ªä»»åŠ¡ä¼šè¢«å–æ¶ˆ
    <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks,
                                  long timeout, TimeUnit unit)
        throws InterruptedException;

    //æäº¤ä¸€å¤§å †çš„çº¿ç¨‹ï¼Œè¿™ä¹ˆå¤šçº¿ç¨‹é‡Œé¢ä¸€ä¸ªæˆåŠŸå°±å¯ä»¥ï¼Œåªè¦ç»™æˆ‘ä¸€ä¸ªè¿”å›å€¼
    <T> T invokeAny(Collection<? extends Callable<T>> tasks)
        throws InterruptedException, ExecutionException;

    //è¿™ä¸ªé“ç†ç±»ä¼¼ï¼Œå°±æ˜¯åœ¨invokeAny(Collection<? extends Callable<T>> tasks) ä¸Šå¢åŠ æ—¶é—´çš„æ§åˆ¶
    <T> T invokeAny(Collection<? extends Callable<T>> tasks,
                    long timeout, TimeUnit unit)
        throws InterruptedException, ExecutionException, TimeoutException;
}
```
3. é‚£ä¹ˆå†ç„¶åå°±æ˜¯AbstractExecutorService è¿™ä¸ªç±»åŸºæœ¬ä¸Šå®ç°äº†ExecutorServiceçš„è¡Œä¸º
   
4. æœ€é‡è¦çš„å‹è½´ç±»å°±æ˜¯ThreadPoolExecutorï¼Œè¿™ä¸ªç±»ç»§æ‰¿äº†AbstractExecutorServiceç±»

## 2. ThreadPoolExecutorç±»çš„é‡è¦field

ThreadPoolExecutorç±» æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç±»ï¼Œé‡Œé¢çš„è¡Œä¸ºé€»è¾‘çº¿æ¡å¾ˆå¤šï¼Œå› æ­¤åœ¨åæœŸçš„è¯´æ˜ä¸­ä¼šè¾…ä»¥å¤§é‡çš„æµç¨‹å›¾è¿›è¡Œè¡¨ç¤ºã€‚

ç±»çš„fieldçš„æ•°é‡ä¹Ÿå¤šçš„å“äººï¼Œå› æ­¤åœ¨é€»è¾‘ä¸Šæˆ‘ä»¬å…ˆå°†å…¨éƒ¨çš„æ ¸å¿ƒé€»è¾‘ç›¸å…³çš„fieldæŒ‰ç…§åŠŸèƒ½è¿›è¡Œåˆ’åˆ†ï¼Œä¸€ä¸€å‡»ç ´å³å¯ã€‚

### 2.1 æŒ‰ç…§åŠŸèƒ½åˆ’åˆ†-çº¿ç¨‹æ± çš„çŠ¶æ€

 é¦–å…ˆå¥‰ä¸Šå„ç§çº¿ç¨‹æ± çŠ¶æ€çš„è¿ç§»å›¾åŠå…¶å…³ç³»

![çº¿ç¨‹æ± çš„çŠ¶æ€è¿ç§»å›¾](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/2.2%E7%8A%B6%E6%80%81%E8%BF%81%E7%A7%BB.png)

```java
    //AQSåˆ™åªæä¾›äº†stateä¸€ä¸ªintå‹å˜é‡ï¼Œæ­¤æ—¶å°†stateé«˜16ä½è¡¨ç¤ºä¸ºè¯»çŠ¶æ€ï¼Œä½16ä½è¡¨ç¤ºä¸ºå†™çŠ¶æ€ã€‚è¿™é‡Œçš„cltåŒæ ·ä¹Ÿæ˜¯ï¼Œå®ƒè¡¨ç¤ºäº†ä¸¤ä¸ªæ¦‚å¿µï¼š
    //1. workerCountï¼šå½“å‰æœ‰æ•ˆçš„çº¿ç¨‹æ•°
    //2. runStateï¼šå½“å‰çº¿ç¨‹æ± çš„äº”ç§çŠ¶æ€ï¼ŒRunningã€Shutdownã€Stopã€Tidyingã€Terminateã€‚
    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));
    //c & é«˜3ä½ä¸º1ï¼Œä½29ä½ä¸º0çš„~CAPACITYï¼Œç”¨äºè·å–é«˜3ä½ä¿å­˜çš„çº¿ç¨‹æ± çŠ¶æ€
    private static int runStateOf(int c)     { return c & ~CAPACITY; }
    //c & é«˜3ä½ä¸º0ï¼Œä½29ä½ä¸º1çš„CAPACITYï¼Œç”¨äºè·å–ä½29ä½çš„çº¿ç¨‹æ•°é‡
    private static int workerCountOf(int c)  { return c & CAPACITY; }
    //å‚æ•°rsè¡¨ç¤ºrunStateï¼Œå‚æ•°wcè¡¨ç¤ºworkerCountï¼Œå³æ ¹æ®runStateå’ŒworkerCountæ‰“åŒ…åˆå¹¶æˆctl
    //é«˜ä¸‰ä½å’Œä½29ä½åˆå¹¶ä¸ºä¸€ä¸ªæœ‰æ„ä¹‰çš„AtomicInteger
    private static int ctlOf(int rs, int wc) { return rs | wc; }


    private static final int CAPACITY = (1 << COUNT_BITS) â€“ 1;    //ä½29ä½è¡¨ç¤ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œ2^29-1
    //å®šä¸€ä¸ªå¸¸é‡ï¼Œåœ¨ä¹‹åå®šä¹‰çŠ¶æ€å€¼æ—¶å€™ä½¿ç”¨
    private static final int COUNT_BITS = Integer.SIZE - 3;       //32-3=29ï¼Œçº¿ç¨‹æ•°é‡æ‰€å ä½æ•°

    //çº¿ç¨‹æ± å¤„åœ¨RUNNINGçŠ¶æ€æ—¶ï¼Œèƒ½å¤Ÿæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä»¥åŠå¯¹å·²æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚
    //çº¿ç¨‹æ± çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯RUNNINGã€‚å½“çº¿ç¨‹æ± è¢«ä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±å¤„äºRUNNINGçŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°ä¸º0
    private static final int RUNNING    = -1 << COUNT_BITS; // intå‹å˜é‡é«˜3ä½ï¼ˆå«ç¬¦å·ä½ï¼‰101è¡¨RUNING

    //å¦‚æœè°ƒç”¨äº†shutdown()æ–¹æ³•ï¼Œåˆ™çº¿ç¨‹æ± å¤„äºSHUTDOWNçŠ¶æ€
    //çº¿ç¨‹æ± å¤„åœ¨SHUTDOWNçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†èƒ½å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ã€‚
    private static final int SHUTDOWN   =  0 << COUNT_BITS; //é«˜3ä½000

    //å¦‚æœè°ƒç”¨äº†shutdownNow()æ–¹æ³•ï¼Œåˆ™çº¿ç¨‹æ± å¤„äºSTOPçŠ¶æ€
    //çº¿ç¨‹æ± å¤„åœ¨STOPçŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚
    private static final int STOP       =  1 << COUNT_BITS; ////é«˜3ä½001

    //å½“æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œå½“å‰ç±»è®°å½•çš„â€ä»»åŠ¡æ•°é‡â€ä¸º0ï¼Œçº¿ç¨‹æ± ä¼šå˜ä¸ºTIDYINGçŠ¶æ€ã€‚å½“çº¿ç¨‹æ± å˜ä¸ºTIDYINGçŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­å‡½æ•°terminated()
    private static final int TIDYING    =  2 << COUNT_BITS; //é«˜3ä½010

    //çº¿ç¨‹æ± å½»åº•ç»ˆæ­¢ï¼Œå°±å˜æˆTERMINATEDçŠ¶æ€ã€‚ 
    private static final int TERMINATED =  3 << COUNT_BITS; //é«˜3ä½011


```

### 2.2 çº¿ç¨‹æ± çš„æ‰§è¡Œæ–¹æ³•ç›¸å…³çš„æ ¸å¿ƒfield
è¿˜æ˜¯å…ˆç¥­å‡ºä¸€æ³¢æ‰€æœ‰çš„fieldåˆ—è¡¨
![ThreadPoolExecutorç±»çš„å…¨éƒ¨field](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/2.1%E7%B1%BB%E4%B8%8Bfield.png)
åœ¨è¿™é‡Œé¢æˆ‘ä»¬æŒ‘é€‰é‡è¦çš„æˆå‘˜å˜é‡è¿›è¡Œè¯´æ˜
```java
    //ä»¥ä¸‹6ä¸ªæˆå‘˜å˜é‡ç›´æ¥ç”±æ„é€ æ–¹æ³•ä¼ å…¥
    //æ ¸å¿ƒæ± çš„å¤§å°ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®å¤§äºè¿™ä¸ªå‚æ•°æ—¶ï¼Œæäº¤çš„ä»»åŠ¡ä¼šè¢«æ”¾è¿›ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—
    private volatile int corePoolSize;                  //1
    private volatile int maximumPoolSize;               //2 çº¿ç¨‹æ± æœ€å¤§èƒ½å®¹å¿çš„çº¿ç¨‹æ•°
    private final BlockingQueue<Runnable> workQueue;    //3 ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜æ”¾ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡
    private volatile long keepAliveTime;                //4 çº¿ç¨‹å­˜æ´»æ—¶é—´
    private volatile ThreadFactory threadFactory;       //5 çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹
    private volatile RejectedExecutionHandler handler;  //6 ä»»åŠ¡æ‹’ç»ç­–ç•¥

    private long completedTaskCount;        //ç”¨æ¥è®°å½•å·²ç»æ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡ä¸ªæ•°
    private volatile int poolSize;          //çº¿ç¨‹æ± ä¸­å½“å‰çš„çº¿ç¨‹æ•°
    private volatile boolean allowCoreThreadTimeOut;   //æ˜¯å¦å…è®¸ä¸ºæ ¸å¿ƒçº¿ç¨‹è®¾ç½®å­˜æ´»æ—¶é—´
    private final HashSet<Worker> workers = new HashSet<Worker>();  //ç”¨æ¥å­˜æ”¾å·¥ä½œçº¿ç¨‹çš„seté›†
    private final ReentrantLock mainLock = new ReentrantLock();     //çº¿ç¨‹æ± çš„ä¸»è¦çŠ¶æ€é” å¾ˆå¤šæ–¹æ³•å¼ºçƒˆä¾èµ–äºè¿™ä¸ªé”

```

### 2.3 çº¿ç¨‹æ± çš„è¾…åŠ©æ€§æ”¯æŒfieldä¸inner class,ä¸€äº›ç›¸å…³çš„æ–¹æ³•
```java
//è¿™æ˜¯ä¸ªçº¿ç¨‹åŒ…è£…ç±»ï¼Œæ—¶æ—¶åˆ»åˆ»åœ¨è¿è¡Œï¼Œä¸æ–­åœ°ä»ä»»åŠ¡åˆ—è¡¨æä»»åŠ¡æ‰§è¡Œ
private final class Worker extends AbstractQueuedSynchronizer implements Runnable {...}
//ä»¥ä¸‹å››ä¸ªinnerç±»å¯ä»¥è§‚å¯Ÿåˆ°éƒ½å®ç°äº†RejectedExecutionHandleræ¥å£ï¼Œè¿™å°±æ˜¯æ‹’ç»ç­–ç•¥å®ä½“ç±»
//æ˜¯ç›´æ¥å®šä¹‰åˆ°ThreadPoolExecutorç±»å†…çš„
public static class CallerRunsPolicy implements RejectedExecutionHandler {...}
public static class AbortPolicy implements RejectedExecutionHandler {...}
public static class DiscardPolicy implements RejectedExecutionHandler {...}
public static class DiscardOldestPolicy implements RejectedExecutionHandler {...}
```

## 3. ThreadPoolExecutorç±»æ„é€ æ–¹æ³•
ThreadPoolExecutorç±»æ„é€ æ–¹æ³• çš„æ„é€ æ–¹æ³•æ€»å…±æœ‰å››ä¸ªï¼Œæœ‰äº›å‚æ•°å¯ä»¥ç¼ºçœï¼Œé‚£ä¹ˆå°±ç”¨é»˜è®¤çš„ä»£æ›¿ï¼Œæœ€ç»ˆè°ƒç”¨çš„å°±æ˜¯ä¸‹é¢æ‰€çœ‹åˆ°çš„æ„é€ æ–¹æ³•
```java
    // è¿™äº›å‚æ•°ä»£è¡¨ä»€ä¹ˆå·²ç»åœ¨ä¸Šä¸ªå°èŠ‚å†…å¨å¨è¿‡äº†ï¼Œåœ¨æ­¤ä¸å†é‡å¤ï¼Œåªå…³å¿ƒæ„é€ å‡½æ•°å†…çš„é€»è¾‘
    // ThreadFactory å¯ä»¥ç¼ºçœï¼Œä»£æ›¿ä¸ºExecutors.defaultThreadFactory()
    // RejectedExecutionHandler å¯ä»¥ç¼ºçœ ä»£æ›¿ä¸º ThreadPoolExecutor.defaultHandler(å†…éƒ¨ç±»AbortPolicyçš„å®ä¾‹)
    public ThreadPoolExecutor(int corePoolSize,int maximumPoolSize,long keepAliveTime,
                              TimeUnit unit,BlockingQueue<Runnable> workQueue,ThreadFactory threadFactory,
                              RejectedExecutionHandler handler) {
        /**
         * 1. æ£€æŸ¥æ•°å€¼å‹çš„å…¥å‚æ˜¯å¦ç¬¦åˆè¦æ±‚
         * 2. æ£€æŸ¥å¼•ç”¨ç±»å‹å…¥å‚æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œåªè¦ä¸€ä¸ªnullå°±æŠ›å¼‚å¸¸
         * 3. è¯¥èµ‹å€¼çš„å°±èµ‹å€¼ï¼Œå„å›å„å®¶ï¼Œå„æ‰¾çˆ¹å¦ˆ
         * 4. keepAliveTime é€šè¿‡TimeUnit(æ—¶é—´ç±»å‹)å’Œ keepAliveTime(æ—¶é—´æ•°å€¼)æœ€ç»ˆç¡®å®šæ ‡å‡†ç±»å‹çš„æ—¶é—´é•¿åº¦
         * */
        if (corePoolSize < 0 ||
            maximumPoolSize <= 0 ||
            maximumPoolSize < corePoolSize ||
            keepAliveTime < 0)
            throw new IllegalArgumentException();
        if (workQueue == null || threadFactory == null || handler == null)
            throw new NullPointerException();
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.workQueue = workQueue;
        this.keepAliveTime = unit.toNanos(keepAliveTime);
        this.threadFactory = threadFactory;
        this.handler = handler;
    }
```
## 4. ThreadPoolExecutorç±»çš„æ ¸å¿ƒæ–¹æ³•(æ ¸å¿ƒé€»è¾‘)
### 4.1 æäº¤ä»»åŠ¡ execute()
ä»ExecutorServiceæ¥å£å®šä¹‰å¯ä»¥å‘ç°ï¼Œæäº¤ä»»åŠ¡çš„æ–¹å¼æ˜¯æœ‰å¾ˆå¤šçš„ï¼Œç„¶è€Œæœ€ç»ˆéƒ½å’Œé¡¶çº§æ¥å£å®šä¹‰çš„execute()æ–¹æ³•åˆ†ä¸å¼€

å› æ­¤æˆ‘ä»¬ä»¥è¿™ä¸ªä¸ºçªç ´å£ï¼Œåˆšå¥½ï¼Œå‰é¢å°èŠ‚å†…æä¾›çš„å°æ¡ˆä¾‹å°±æ˜¯ä½¿ç”¨execute()æ–¹æ³•æäº¤çš„ä»»åŠ¡
```java
public void execute(Runnable command) {
        // å¦‚æœä¼ å…¥ä¸ºç©ºï¼Œåˆ™æŠ›å¼‚å¸¸
        if (command == null)
            throw new NullPointerException();
        ////ç”±å®ƒå¯ä»¥è·å–åˆ°å½“å‰æœ‰æ•ˆçš„çº¿ç¨‹æ•°å’Œçº¿ç¨‹æ± çš„çŠ¶æ€
        int c = ctl.get();
        //è·å–å½“å‰æ­£åœ¨è¿è¡Œçº¿ç¨‹æ•°æ˜¯å¦å°äºæ ¸å¿ƒçº¿ç¨‹æ± ï¼Œæ˜¯åˆ™æ–°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå¦åˆ™å°†ä»»åŠ¡æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­
        //æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œèµ‹ç»™workerå®ä¾‹ï¼Œworkerçº¿ç¨‹è°ƒç”¨commandçš„runæ–¹æ³•
        
        if (workerCountOf(c) < corePoolSize) { 
            //addWorker(command, true)å¤±è´¥çš„åŸå› å¯èƒ½æ˜¯ï¼š
            //  1. çº¿ç¨‹æ± å·²ç»shutdownï¼Œshutdownçš„çº¿ç¨‹æ± ä¸å†æ¥æ”¶æ–°ä»»åŠ¡
            //  2. workerCountOf(c) < corePoolSize åˆ¤æ–­åï¼Œç”±äºå¹¶å‘ï¼Œåˆ«çš„çº¿ç¨‹å…ˆåˆ›å»ºäº†workerçº¿ç¨‹ï¼Œå¯¼è‡´workerCount>=corePoolSize
            //åœ¨addWorkerä¸­åˆ›å»ºå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
            if (addWorker(command, true))
                return;
            c = ctl.get();
        }
        //å½“å‰æ ¸å¿ƒçº¿ç¨‹æ± ä¸­å…¨éƒ¨çº¿ç¨‹éƒ½åœ¨è¿è¡Œ
        //è”ç³»ä¸Šä¸€æ­¥çš„åˆ†æï¼Œæ²¡æœ‰åŠæ³•äº§ç”Ÿworkerå®ä¾‹ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œå°è¯•æ”¾å…¥é˜Ÿåˆ— å¤±è´¥å¯èƒ½æ˜¯é˜Ÿåˆ—å·²æ»¡
        if (isRunning(c) && workQueue.offer(command)) {
            //æˆåŠŸè¿›å…¥æ­¤é€»è¾‘
            //è¡¨ç¤º : çº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä¸”ä»»åŠ¡æ’å…¥ä»»åŠ¡é˜Ÿåˆ—æˆåŠŸ
            //------------------------------------

            //å†æ¬¡æˆ–å¾—åˆ°å½“å‰çº¿ç¨‹æ± çŠ¶æ€ï¼Œå› ä¸ºçº¿ç¨‹æ± æ—¶æ—¶åˆ»åˆ»çŠ¶æ€éƒ½ä¼šå‘ç”Ÿæ”¹å˜
            int recheck = ctl.get();

            //çº¿ç¨‹æ± ä¸å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œåˆ™ä½¿åˆšåˆšçš„ä»»åŠ¡å‡ºé˜Ÿ
            // ! isRunning(recheck) å…ˆæ‰§è¡Œï¼Œæ•´ä½“æ˜¯trueï¼Œåˆ™æ‰§è¡Œremove(command)
            //    åˆšå¥½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶æ¶ˆè€—äº†è¿™ä¸ªä»»åŠ¡,ä¼šå¯¼è‡´remove(command)å¤±è´¥
            //    ç¡®ä¿è¿˜æœ‰çº¿ç¨‹æ‰§è¡Œä»»åŠ¡
            // ! isRunning(recheck) å…ˆæ‰§è¡Œ,æ•´ä½“æ˜¯false,åˆ™çŸ­è·¯
            if (! isRunning(recheck) && remove(command))
                //æŠ›å‡ºRejectedExceptionExceptionå¼‚å¸¸
                reject(command);
            else if (workerCountOf(recheck) == 0)
                addWorker(null, false);
        }
        //æ’å…¥é˜Ÿåˆ—ä¸æˆåŠŸï¼Œä¸”å½“å‰çº¿ç¨‹æ•°æ•°é‡å°äºæœ€å¤§çº¿ç¨‹æ± æ•°é‡ï¼Œæ­¤æ—¶åˆ™åˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œåˆ›å»ºå¤±è´¥æŠ›å‡ºå¼‚å¸¸
        else if (!addWorker(command, false))
            //æŠ›å‡ºRejectedExceptionExceptionå¼‚å¸¸
            reject(command);
    }
```
æµç¨‹ä¸»é€»è¾‘æœ‰ï¼š

(1) å¦‚æœçº¿ç¨‹æ± å½“å‰çº¿ç¨‹æ•°é‡å°‘äºcorePoolSizeï¼Œåˆ™addWorker(command, true)åˆ›å»ºæ–°workerçº¿ç¨‹ï¼Œå¦‚åˆ›å»ºæˆåŠŸè¿”å›ï¼Œå¦‚æ²¡åˆ›å»ºæˆåŠŸï¼Œåˆ™æ‰§è¡Œåç»­æ­¥éª¤ï¼›

(2) å¦‚æœçº¿ç¨‹æ± è¿˜åœ¨runningçŠ¶æ€ï¼Œå°†taskåŠ å…¥workQueueé˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœåŠ å…¥æˆåŠŸï¼Œè¿›è¡Œdouble-checkï¼Œå¦‚æœåŠ å…¥å¤±è´¥ï¼Œåˆ™æ‰§è¡Œåç»­æ­¥éª¤ï¼›

(3) å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯runningçŠ¶æ€ æˆ–è€… æ— æ³•å…¥é˜Ÿåˆ—ï¼Œå°è¯•å¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰©å®¹è‡³maxPoolSizeï¼Œå¦‚æœaddWork(command, false)å¤±è´¥äº†ï¼Œæ‹’ç»å½“å‰command

ç›´æ¥ä¸Šä¸ªå›¾ï¼ï¼ï¼

![executeçš„æ‰§è¡Œé¡ºåº](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/3.1execute.png)

### 4.2 addWorker()
```java
/**
 * æ­¤æ–¹æ³•å¯ä»¥æœ‰å››ç§å½¢æ€
 * 1. addWorker(command, true)
 * 2. addWorker(command, false)
 * 3. addWorker(null, false)
 * 4. addWorker(null, true)
 *   ç¬¬ä¸€ä¸ªï¼šçº¿ç¨‹æ•°å°äºcorePoolSizeæ—¶ï¼Œæ”¾ä¸€ä¸ªéœ€è¦å¤„ç†çš„taskè¿›Workers Setã€‚å¦‚æœWorkers Seté•¿åº¦è¶…è¿‡corePoolSizeï¼Œå°±è¿”å›false
 *   ç¬¬äºŒä¸ªï¼šå½“é˜Ÿåˆ—è¢«æ”¾æ»¡æ—¶ï¼Œå°±å°è¯•å°†è¿™ä¸ªæ–°æ¥çš„taskç›´æ¥æ”¾å…¥Workers Setï¼Œè€Œæ­¤æ—¶Workers Setçš„é•¿åº¦é™åˆ¶æ˜¯maximumPoolSizeã€‚å¦‚æœçº¿ç¨‹æ± ä¹Ÿæ»¡äº†çš„è¯å°±è¿”å›false
 *   ç¬¬ä¸‰ä¸ªï¼šæ”¾å…¥ä¸€ä¸ªç©ºçš„taskè¿›workers Setï¼Œé•¿åº¦é™åˆ¶æ˜¯maximumPoolSizeã€‚è¿™æ ·ä¸€ä¸ªtaskä¸ºç©ºçš„workeråœ¨çº¿ç¨‹æ‰§è¡Œçš„æ—¶å€™ä¼šå»ä»»åŠ¡é˜Ÿåˆ—é‡Œæ‹¿ä»»åŠ¡ï¼Œè¿™æ ·å°±ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œåªæ˜¯æ²¡æœ‰é©¬ä¸Šåˆ†é…ä»»åŠ¡
 *   ç¬¬å››ä¸ªï¼šè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ”¾ä¸€ä¸ªnullçš„taskè¿›Workers Setï¼Œè€Œä¸”æ˜¯åœ¨å°äºcorePoolSizeæ—¶ï¼Œå¦‚æœæ­¤æ—¶Setä¸­çš„æ•°é‡å·²ç»è¾¾åˆ°corePoolSizeé‚£å°±è¿”å›falseï¼Œä»€ä¹ˆä¹Ÿä¸å¹²ã€‚å®é™…ä½¿ç”¨ä¸­æ˜¯åœ¨prestartAllCoreThreads()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥ä¸ºçº¿ç¨‹æ± é¢„å…ˆå¯åŠ¨corePoolSizeä¸ªworkerç­‰å¾…ä»workQueueä¸­è·å–ä»»åŠ¡æ‰§è¡Œ
 *
 */
private boolean addWorker(Runnable firstTask, boolean core) {
        //å¤–å±‚å¾ªç¯æ ‡å¿—
        //break retry; æŒ‡çš„æ˜¯è·³å‡ºè¿™ä¸ªå¤§å¾ªç¯
        //continue retry; æŒ‡çš„æ˜¯ç»§ç»­è¿™ä¸ªå¤§å¾ªç¯
        retry:
        for (;;) {
            //å¤–å±‚å¾ªç¯ï¼Œä¸€å€¼åˆ·æ–°cä¸rså€¼
            int c = ctl.get();
            int rs = runStateOf(c);

            // çº¿ç¨‹æ± çš„stateè¶Šå°è¶Šæ˜¯è¿è¡ŒçŠ¶æ€ï¼Œrunnbale=-1ï¼Œshutdown=0,stop=1,tidying=2ï¼Œterminated=3
            //1ã€å¦‚æœçº¿ç¨‹æ± stateå·²ç»è‡³å°‘æ˜¯shutdownçŠ¶æ€äº†
            //2ã€å¹¶ä¸”ä»¥ä¸‹3ä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªæ˜¯false
            //  a)rs == SHUTDOWN         ï¼ˆéšå«ï¼šrs>=SHUTDOWNï¼‰falseæƒ…å†µï¼š
            //                            çº¿ç¨‹æ± çŠ¶æ€å·²ç»è¶…è¿‡shutdownï¼Œå¯èƒ½æ˜¯stopã€tidyingã€terminatedå…¶ä¸­ä¸€ä¸ªï¼Œå³çº¿ç¨‹æ± å·²ç»ç»ˆæ­¢
            //  b)firstTask == null      ï¼ˆéšå«ï¼šrs==SHUTDOWNï¼‰falseæƒ…å†µï¼š 
            //                            firstTaskä¸ä¸ºç©ºï¼Œrs==SHUTDOWN ä¸” firstTaskä¸ä¸ºç©ºï¼Œreturn falseï¼Œ
            //                            (åœºæ™¯æ˜¯åœ¨çº¿ç¨‹æ± å·²ç»shutdownåï¼Œè¿˜è¦æ·»åŠ æ–°çš„ä»»åŠ¡ï¼Œåˆ™æ‹’ç»)
            //  c)! workQueue.isEmpty()  ï¼ˆéšå«ï¼šrs==SHUTDOWNï¼ŒfirstTask==nullï¼‰falseæƒ…å†µï¼š
            //                            workQueueä¸ºç©ºï¼Œå½“firstTaskä¸ºç©ºæ—¶æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ä»»åŠ¡çš„çº¿ç¨‹ï¼Œå†ä»workQueueä¸­è·å–ä»»åŠ¡
            //                            å¦‚æœworkQueueå·²ç»ä¸ºç©ºï¼Œé‚£ä¹ˆå°±æ²¡æœ‰æ·»åŠ æ–°workerçº¿ç¨‹çš„å¿…è¦äº†
            // return falseï¼Œå³æ— æ³•addWorker()
            if (rs >= SHUTDOWN &&
                ! (rs == SHUTDOWN &&
                   firstTask == null &&
                   ! workQueue.isEmpty()))
                return false;

            ////å†…å±‚å¾ªç¯ï¼Œè´Ÿè´£workeræ•°é‡+1
            for (;;) {
                int wc = workerCountOf(c);
                //å¦‚æœworkeræ•°é‡>çº¿ç¨‹æ± æœ€å¤§ä¸Šé™CAPACITYï¼ˆå³ä½¿ç”¨intä½29ä½å¯ä»¥å®¹çº³çš„æœ€å¤§å€¼ï¼‰
                //æˆ–è€…( workeræ•°é‡>corePoolSize æˆ–  workeræ•°é‡>maximumPoolSize )ï¼Œå³å·²ç»è¶…è¿‡äº†ç»™å®šçš„è¾¹ç•Œ
                if (wc >= CAPACITY ||
                    wc >= (core ? corePoolSize : maximumPoolSize))
                    return false;
                //è°ƒç”¨unsafe CASæ“ä½œï¼Œä½¿å¾—workeræ•°é‡+1ï¼ŒæˆåŠŸåˆ™è·³å‡ºretryå¾ªç¯
                if (compareAndIncrementWorkerCount(c))
                    break retry;
                //CAS workeræ•°é‡+1å¤±è´¥ï¼Œå†æ¬¡è¯»å–ctl
                c = ctl.get();  // Re-read ctl
                if (runStateOf(c) != rs)
                    continue retry;
                // else CASå¤±è´¥æ—¶å› ä¸ºworkerCountæ”¹å˜äº†ï¼Œç»§ç»­å†…å±‚å¾ªç¯å°è¯•CASå¯¹workeræ•°é‡+1
            }
        }

        /**
         * workeræ•°é‡+1æˆåŠŸçš„åç»­æ“ä½œ
         * æ·»åŠ åˆ°workers Seté›†åˆï¼Œå¹¶å¯åŠ¨workerçº¿ç¨‹
         */
        boolean workerStarted = false;
        boolean workerAdded = false;
        Worker w = null;
        try {
            //1ã€è®¾ç½®workerè¿™ä¸ªAQSé”çš„åŒæ­¥çŠ¶æ€state=-1
            //2ã€å°†firstTaskè®¾ç½®ç»™workerçš„æˆå‘˜å˜é‡firstTask
            //3ã€ä½¿ç”¨workerè‡ªèº«è¿™ä¸ªrunnableï¼Œè°ƒç”¨ThreadFactoryåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶è®¾ç½®ç»™workerçš„æˆå‘˜å˜é‡thread
            w = new Worker(firstTask);
            final Thread t = w.thread;
            if (t != null) {
                final ReentrantLock mainLock = this.mainLock;
                mainLock.lock();
                try {
                    // å½“è·å–åˆ°é”åï¼Œå†æ¬¡æ£€æŸ¥
                    int rs = runStateOf(ctl.get());

                    //å¦‚æœçº¿ç¨‹æ± åœ¨è¿è¡Œrunning<shutdown æˆ–è€… çº¿ç¨‹æ± å·²ç»shutdownï¼Œä¸”firstTask==nullï¼ˆå¯èƒ½æ˜¯workQueueä¸­ä»æœ‰æœªæ‰§è¡Œå®Œæˆçš„ä»»åŠ¡ï¼Œåˆ›å»ºæ²¡æœ‰åˆå§‹ä»»åŠ¡çš„workerçº¿ç¨‹æ‰§è¡Œï¼‰
                    //workeræ•°é‡-1çš„æ“ä½œåœ¨addWorkerFailed()
                    if (rs < SHUTDOWN ||
                        (rs == SHUTDOWN && firstTask == null)) {
                        if (t.isAlive()) // precheck that t is startable   çº¿ç¨‹å·²ç»å¯åŠ¨ï¼ŒæŠ›éæ³•çº¿ç¨‹çŠ¶æ€å¼‚å¸¸
                            throw new IllegalThreadStateException();
                        //workersæ˜¯ä¸€ä¸ªHashSet<Worker>
                        workers.add(w);
                        //è®¾ç½®æœ€å¤§çš„æ± å¤§å°largestPoolSizeï¼ŒworkerAddedè®¾ç½®ä¸ºtrue
                        int s = workers.size();
                        if (s > largestPoolSize)
                            largestPoolSize = s;
                        workerAdded = true;
                    }
                } finally {
                    mainLock.unlock();
                }
                //å¦‚æœå¾€HashSetä¸­æ·»åŠ workeræˆåŠŸï¼Œå¯åŠ¨çº¿ç¨‹
                if (workerAdded) {
                    t.start();
                    workerStarted = true;
                }
            }
        } finally {
            //å¦‚æœå¯åŠ¨çº¿ç¨‹å¤±è´¥
            if (! workerStarted)
                addWorkerFailed(w);
        }
        return workerStarted;
    }
```
æºç å¾ˆé•¿å¾ˆé•¿ï¼Œå¤ªå“äººäº†ï¼Œç®€å•çš„çœ‹çš„è¯ï¼Œè¿™é‡Œé¢å°±å¹²äº†ä¸¤ä»¶äº‹æƒ…ï¼Œ

1. ä½¿ç”¨å¾ªç¯CASæ“ä½œæ¥å°†çº¿ç¨‹æ•°åŠ 1ï¼›
2. æ–°å»ºä¸€ä¸ªçº¿ç¨‹å¹¶å¯ç”¨ã€‚

![addworkerçš„æµç¨‹å›¾](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/3.2addworker.png)

### 4.3 Workerå†…éƒ¨ç±»
```java
/**
 * è¿™ä¸ªç±»å°±æ˜¯çº¿ç¨‹æ± é‡Œé¢ä¸€ç›´è¿è¡Œç€çš„çº¿ç¨‹ï¼Œå‡†ç¡®çš„è¯´æ˜¯çº¿ç¨‹çš„åŒ…è£…ç±»
 * Workerç±»åŠŸèƒ½ä¸Šç®¡ç†ç€è¿è¡Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ å’Œ ä¸€äº›æŒ‡æ ‡
 * Workerç±»å®ç°äº†Runnableï¼Œå› æ­¤æ—¢æ˜¯ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿæ˜¯ä¸€æŠŠé”ï¼ˆä¸å¯é‡å…¥ï¼‰
 * Workerç±»ç»§æ‰¿äº†AQSï¼Œç®€åŒ–åœ¨æ‰§è¡Œä»»åŠ¡æ—¶çš„è·å–ï¼Œé‡Šæ”¾é”ï¼Œå®ç°äº†Runnableï¼Œå› æ­¤æ—¢æ˜¯ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œä¹Ÿæ˜¯ä¸€æŠŠé”ï¼ˆä¸å¯é‡å…¥ï¼‰
 *      1. é˜²æ­¢äº†ä¸­æ–­åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ï¼Œåªä¼šå”¤é†’(ä¸­æ–­)åœ¨ç­‰å¾…ä»workQueueä¸­è·å–ä»»åŠ¡çš„çº¿ç¨‹
        2. æ§åˆ¶ä¸Šä½¿ç”¨AQSé”ï¼Œå½“è¿è¡Œæ—¶ä¸Šé”ï¼Œå°±ä¸èƒ½ä¸­æ–­ï¼ŒTreadPoolExecutorçš„shutdown()æ–¹æ³•ä¸­æ–­å‰éƒ½è¦è·å–workeré”
 *      3. åªæœ‰åœ¨ç­‰å¾…ä»workQueueä¸­è·å–ä»»åŠ¡getTask()æ—¶æ‰èƒ½ä¸­æ–­
 * Workerç±»å®ç°äº†ä¸€ä¸ªç®€å•çš„ä¸å¯é‡å…¥çš„äº’æ–¥é”ï¼Œè€Œä¸æ˜¯ç”¨ReentrantLockå¯é‡å…¥é”
 * ä¸ºäº†è®©çº¿ç¨‹çœŸæ­£å¼€å§‹åæ‰å¯ä»¥ä¸­æ–­ï¼Œåˆå§‹åŒ–lockçŠ¶æ€ä¸ºè´Ÿå€¼(-1)ï¼Œåœ¨å¼€å§‹runWorker()æ—¶å°†stateç½®ä¸º0ï¼Œè€Œstate>=0æ‰å¯ä»¥ä¸­æ–­
 *
 */
private final class Worker extends AbstractQueuedSynchronizer implements Runnable {

        private static final long serialVersionUID = 6138294804551838833L;

        //åˆ©ç”¨ThreadFactoryå’Œ Workerè¿™ä¸ªRunnableåˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡
        //å·¥å‚äº§ç”Ÿçº¿ç¨‹å¤±è´¥çš„è¯ï¼Œåˆ™èµ‹å€¼null
        Runnable firstTask;
        //æ¯ä¸ªçº¿ç¨‹çš„taskè®¡æ•°å™¨
        volatile long completedTasks;

        Worker(Runnable firstTask) {
            // 1ã€å°†AQSçš„stateç½®ä¸º-1(å¤§äº0ä»£è¡¨é”å·²ç»è¢«è·å–)ï¼Œåœ¨runWoker()å‰ä¸å…è®¸ä¸­æ–­
            //    åœ¨è°ƒç”¨runWorker()å‰ï¼Œç¦æ­¢interruptä¸­æ–­ï¼Œåœ¨interruptIfStarted()æ–¹æ³•ä¸­ä¼šåˆ¤æ–­ getState()>=0
            // 2ã€å¾…æ‰§è¡Œçš„ä»»åŠ¡ä¼šä»¥å‚æ•°ä¼ å…¥ï¼Œå¹¶èµ‹äºˆfirstTask
            // 3ã€æ ¹æ®å½“å‰workeråˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
            //    å½“å‰workeræ˜¯ä¸€ä¸ªrunnableä»»åŠ¡,ä¹Ÿå°±æ˜¯ä¸ä¼šç”¨å‚æ•°çš„firstTaskåˆ›å»ºçº¿ç¨‹ï¼Œè€Œæ˜¯è°ƒç”¨å½“å‰worker.run()æ—¶è°ƒç”¨firstTask.run()
            setState(-1); // inhibit interrupts until runWorker
            this.firstTask = firstTask;
            this.thread = getThreadFactory().newThread(this);
        }

        public void run() {
            //runWorker()æ˜¯ThreadPoolExecutorçš„æ–¹æ³•
            runWorker(this);
        }

        //getState()è¿”å›çš„æ˜¯0 è¡¨ç¤ºunlockedçŠ¶æ€
        //è¿”å›æ—¶1 åˆ™æ˜¯locked çŠ¶æ€
        protected boolean isHeldExclusively() {
            return getState() != 0;
        }

        
        /**
         * å°è¯•è·å–é”
         * é‡å†™AQSçš„tryAcquire()ï¼ŒAQSæœ¬æ¥å°±æ˜¯è®©å­ç±»æ¥å®ç°çš„
         */
        protected boolean tryAcquire(int unused) {
            //å°è¯•ä¸€æ¬¡å°†stateä»0è®¾ç½®ä¸º1ï¼Œå³â€œé”å®šâ€çŠ¶æ€ï¼Œä½†ç”±äºæ¯æ¬¡éƒ½æ˜¯state 0->1ï¼Œè€Œä¸æ˜¯+1ï¼Œé‚£ä¹ˆè¯´æ˜ä¸å¯é‡å…¥
            //ä¸”state==-1æ—¶ä¹Ÿä¸ä¼šè·å–åˆ°é”
            if (compareAndSetState(0, 1)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            }
            return false;
        }

        /**
         * å°è¯•é‡Šæ”¾é”
         * ä¸æ˜¯state-1ï¼Œè€Œæ˜¯ç½®ä¸º0
         */
        protected boolean tryRelease(int unused) {
            setExclusiveOwnerThread(null);
            setState(0);
            return true;
        }

        public void lock()        { acquire(1); }
        public boolean tryLock()  { return tryAcquire(1); }
        public void unlock()      { release(1); }
        public boolean isLocked() { return isHeldExclusively(); }

        /**
         * ä¸­æ–­ï¼ˆå¦‚æœè¿è¡Œï¼‰
         * shutdownNowæ—¶ä¼šå¾ªç¯å¯¹workerçº¿ç¨‹æ‰§è¡Œ
         * ä¸”ä¸éœ€è¦è·å–workeré”ï¼Œå³ä½¿åœ¨workerè¿è¡Œæ—¶ä¹Ÿå¯ä»¥ä¸­æ–­
         */
        void interruptIfStarted() {
            Thread t;
            //å¦‚æœstate>=0ã€t!=nullã€ä¸”tæ²¡æœ‰è¢«ä¸­æ–­
            //new Worker()æ—¶state==-1ï¼Œè¯´æ˜ä¸èƒ½ä¸­æ–­
            if (getState() >= 0 && (t = thread) != null && !t.isInterrupted()) {
                try {
                    t.interrupt();
                } catch (SecurityException ignore) {
                }
            }
        }
    }
```
(1)åˆå§‹AQSçŠ¶æ€ä¸º-1ï¼Œæ­¤æ—¶ä¸å…è®¸ä¸­æ–­interrupt()ï¼Œåªæœ‰åœ¨workerçº¿ç¨‹å¯åŠ¨äº†ï¼Œæ‰§è¡Œäº†runWoker()ï¼Œå°†stateç½®ä¸º0ï¼Œæ‰èƒ½ä¸­æ–­ã€‚

(2)shutdown()çº¿ç¨‹æ± æ—¶ï¼Œä¼šå¯¹æ¯ä¸ªworkeræ‰§è¡ŒtryLock()ä¸Šé”ï¼Œè€ŒWorkerç±»è¿™ä¸ªAQSçš„tryAcquire()æ–¹æ³•æ˜¯å›ºå®šå°†stateä»0->1ï¼Œæ•…åˆå§‹çŠ¶æ€state==-1æ—¶tryLock()å¤±è´¥ï¼Œä¸èƒ½interrupt()

(3)shutdownNow()çº¿ç¨‹æ± æ—¶ï¼Œä¸ç”¨tryLock()ä¸Šé”ï¼Œä½†è°ƒç”¨worker.interruptIfStarted()ç»ˆæ­¢workerï¼ŒinterruptIfStarted()ä¹Ÿæœ‰state>0æ‰èƒ½interruptçš„é€»è¾‘

(4)ä¸ºäº†é˜²æ­¢æŸç§æƒ…å†µä¸‹ï¼Œåœ¨è¿è¡Œä¸­çš„workerè¢«ä¸­æ–­ï¼ŒrunWorker()æ¯æ¬¡è¿è¡Œä»»åŠ¡æ—¶éƒ½ä¼šlock()ä¸Šé”ï¼Œè€Œshutdown()è¿™ç±»å¯èƒ½ä¼šç»ˆæ­¢workerçš„æ“ä½œéœ€è¦å…ˆè·å–workerçš„é”ï¼Œè¿™æ ·å°±é˜²æ­¢äº†ä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹


### 4.4 runWorker() æ–¹æ³•è¯¦è§£
```java

/**
 * é‡å¤åœ°ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œä¸æ­¤åŒæ—¶éœ€è¦é¢ä¸´ä¸€äº›é—®é¢˜
 *
 * 1. æˆ‘ä»¬å¯èƒ½ä½¿ç”¨ä¸€ä¸ªåˆå§‹åŒ–ä»»åŠ¡å¼€å§‹ï¼Œå³firstTaskä¸ºnull
 *    ç„¶ååªè¦çº¿ç¨‹æ± åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å°±ä»getTask()è·å–ä»»åŠ¡
 *    å¦‚æœgetTask()è¿”å›nullï¼Œåˆ™workerç”±äºæ”¹å˜äº†çº¿ç¨‹æ± çŠ¶æ€æˆ–å‚æ•°é…ç½®è€Œé€€å‡º
 *    å…¶å®ƒé€€å‡ºå› ä¸ºå¤–éƒ¨ä»£ç æŠ›å¼‚å¸¸äº†ï¼Œè¿™ä¼šä½¿å¾—completedAbruptlyä¸ºtrueï¼Œè¿™ä¼šå¯¼è‡´åœ¨processWorkerExit()æ–¹æ³•ä¸­æ›¿æ¢å½“å‰çº¿ç¨‹
 *
 * 2. åœ¨ä»»ä½•ä»»åŠ¡æ‰§è¡Œä¹‹å‰ï¼Œéƒ½éœ€è¦å¯¹workeråŠ é”å»é˜²æ­¢åœ¨ä»»åŠ¡è¿è¡Œæ—¶ï¼Œå…¶å®ƒçš„â€œçº¿ç¨‹æ± ä¸­æ–­æ“ä½œâ€
 *    è°ƒç”¨clearInterruptsForTaskRunä¿è¯-é™¤éçº¿ç¨‹æ± æ­£åœ¨stopingï¼Œå¦åˆ™çº¿ç¨‹ä¸ä¼šè¢«è®¾ç½®ä¸­æ–­æ ‡ç¤º
 *
 * 3. æ¯ä¸ªä»»åŠ¡æ‰§è¡Œå‰ä¼šè°ƒç”¨beforeExecute()
 *    å…¶ä¸­å¯èƒ½æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡ï¼ˆè·³å‡ºå¾ªç¯ï¼Œä¸”completedAbruptly==trueï¼‰
 *    ä¼šå¯¼è‡´æ²¡æœ‰æ‰§è¡Œä»»åŠ¡
 *
 * 4. å‡å®šbeforeExecute()æ­£å¸¸å®Œæˆï¼Œæ±‡æ€»ä»»ä½•æŠ›å‡ºçš„å¼‚å¸¸é€ç»™afterExecute
 *    å› ä¸ºæˆ‘ä»¬ä¸èƒ½åœ¨Runnable.run()æ–¹æ³•ä¸­é‡æ–°ä¸ŠæŠ›Throwablesï¼Œ
 *    æˆ‘ä»¬å°†ThrowablesåŒ…è£…åˆ°Errorsä¸ŠæŠ›(ä¼šåˆ°çº¿ç¨‹çš„UncaughtExceptionHandlerå»å¤„ç†ï¼‰
 *   (ä»»ä½•ä¸ŠæŠ›çš„å¼‚å¸¸éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡)
 *
 * 5. ä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œè°ƒç”¨afterExecute()ï¼Œä¹Ÿå¯èƒ½æŠ›å¼‚å¸¸ï¼Œä¹Ÿä¼šå¯¼è‡´çº¿ç¨‹die
 */
final void runWorker(Worker w) {
    Thread wt = Thread.currentThread();
    Runnable task = w.firstTask;
    w.firstTask = null;
    // å…è®¸ä¸­æ–­
    // new Worker()æ˜¯state==-1ï¼Œæ­¤å¤„æ˜¯è°ƒç”¨Workerç±»çš„tryRelease()æ–¹æ³•ï¼Œå°†stateç½®ä¸º0
    // è€ŒinterruptIfStarted()ä¸­åªæœ‰state>=0æ‰å…è®¸è°ƒç”¨ä¸­æ–­
    w.unlock(); 
    //æ˜¯å¦â€œçªç„¶å®Œæˆâ€ï¼Œå¦‚æœæ˜¯ç”±äºå¼‚å¸¸å¯¼è‡´çš„è¿›å…¥finallyï¼Œé‚£ä¹ˆcompletedAbruptly==trueå°±æ˜¯çªç„¶å®Œæˆçš„
    boolean completedAbruptly = true; 
    try {
        /**
         * å¦‚æœtaskä¸ä¸ºnullï¼Œæˆ–è€…ä»é˜»å¡é˜Ÿåˆ—ä¸­getTask()ä¸ä¸ºnull
         */
        while (task != null || (task = getTask()) != null) {
            //ä¸Šé”ï¼Œä¸æ˜¯ä¸ºäº†é˜²æ­¢å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œä¸ºäº†åœ¨shutdown()æ—¶ä¸ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„worker
            w.lock(); 
            /**
             * clearInterruptsForTaskRunæ“ä½œ
             * ç¡®ä¿åªæœ‰åœ¨çº¿ç¨‹stopingæ—¶ï¼Œæ‰ä¼šè¢«è®¾ç½®ä¸­æ–­æ ‡ç¤ºï¼Œå¦åˆ™æ¸…é™¤ä¸­æ–­æ ‡ç¤º
             * 1ã€å¦‚æœçº¿ç¨‹æ± çŠ¶æ€>=stopï¼Œä¸”å½“å‰çº¿ç¨‹æ²¡æœ‰è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼Œwt.interrupt()
             * 2ã€å¦‚æœä¸€å¼€å§‹åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€<stopï¼Œ
             *    ä½†Thread.interrupted()ä¸ºtrueï¼Œå³çº¿ç¨‹å·²ç»è¢«ä¸­æ–­ï¼Œåˆæ¸…é™¤äº†ä¸­æ–­æ ‡ç¤ºï¼Œ
             *    é‚£ä¹ˆå†æ¬¡åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦>=stop
             *       å¦‚æœ æ˜¯ï¼Œå†æ¬¡è®¾ç½®ä¸­æ–­æ ‡ç¤ºï¼Œwt.interrupt()
             *       å¦‚æœ å¦ï¼Œä¸åšæ“ä½œï¼Œæ¸…é™¤ä¸­æ–­æ ‡ç¤ºåè¿›è¡Œåç»­æ­¥éª¤
             */
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &&
                  runStateAtLeast(ctl.get(), STOP))) &&
                !wt.isInterrupted())
                //è°ƒç”¨interrupt()ä¸­æ–­
                wt.interrupt(); 
             
            try {
                //æ‰§è¡Œå‰ï¼ˆå­ç±»å®ç°ï¼‰
                beforeExecute(wt, task);
                 
                Throwable thrown = null;
                try {
                    task.run();
                } 
                catch (RuntimeException x) {
                    thrown = x; throw x;
                } 
                catch (Error x) {
                    thrown = x; throw x;
                } 
                catch (Throwable x) {
                    thrown = x; throw new Error(x);
                } 
                finally {
                    //æ‰§è¡Œåï¼ˆå­ç±»å®ç°ï¼‰
                    afterExecute(task, thrown);
                }
            } 
            finally {
                task = null; //taskç½®ä¸ºnull
                w.completedTasks++; //å®Œæˆä»»åŠ¡æ•°+1
                w.unlock(); //è§£é”
            }
        }
         
        completedAbruptly = false;
    } 
    finally {
        //å¤„ç†workerçš„é€€å‡º
        processWorkerExit(w, completedAbruptly);
    }
}
```
æ‰§è¡Œæµç¨‹ï¼š

(1)Workerçº¿ç¨‹å¯åŠ¨åï¼Œé€šè¿‡Workerç±»çš„run()æ–¹æ³•è°ƒç”¨runWorker(this)

(2)æ‰§è¡Œä»»åŠ¡ä¹‹å‰ï¼Œé¦–å…ˆworker.unlock()ï¼Œå°†AQSçš„stateç½®ä¸º0ï¼Œå…è®¸ä¸­æ–­å½“å‰workerçº¿ç¨‹

(3)å¼€å§‹æ‰§è¡ŒfirstTaskï¼Œè°ƒç”¨task.run()ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡å‰ä¼šä¸Šé”wroker.lock()ï¼Œåœ¨æ‰§è¡Œå®Œä»»åŠ¡åä¼šè§£é”ï¼Œä¸ºäº†é˜²æ­¢åœ¨ä»»åŠ¡è¿è¡Œæ—¶è¢«çº¿ç¨‹æ± ä¸€äº›ä¸­æ–­æ“ä½œä¸­æ–­

(4)åœ¨ä»»åŠ¡æ‰§è¡Œå‰åï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªå®šä¹‰beforeExecute() å’Œ afterExecute()æ–¹æ³•

(5)æ— è®ºåœ¨beforeExecute()ã€task.run()ã€afterExecute()å‘ç”Ÿå¼‚å¸¸ä¸ŠæŠ›ï¼Œéƒ½ä¼šå¯¼è‡´workerçº¿ç¨‹ç»ˆæ­¢ï¼Œè¿›å…¥processWorkerExit()å¤„ç†workeré€€å‡ºçš„æµç¨‹

(6)å¦‚æ­£å¸¸æ‰§è¡Œå®Œå½“å‰taskåï¼Œä¼šé€šè¿‡getTask()ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œä¸”è·å–ä»»åŠ¡è¶…æ—¶ï¼Œé‚£ä¹ˆå½“å‰workerä¹Ÿä¼šè¿›å…¥é€€å‡ºæµç¨‹

ä¸Šä¸€æ³¢å›¾ï¼šçœ‹å¾—æ›´èˆ’æœ

![runWorkerå›¾](https://gitee.com/alan-tang-tt/yuan/raw/master/%E6%AD%BB%E7%A3%95%20java%E5%B9%B6%E5%8F%91%E5%8C%85/resource/%E7%BA%BF%E7%A8%8B%E6%B1%A0/4.4runWorker(\).png)


### 4.5 getTask()  --  è·å–ä»»åŠ¡

```java
/**
 * ä»¥ä¸‹æƒ…å†µä¼šè¿”å›null
 * 1. çº¿ç¨‹æ± å†…æœ‰è¶…è¿‡äº†maximumPoolSizeè®¾ç½®çš„çº¿ç¨‹æ•°é‡ï¼ˆå› ä¸ºè°ƒç”¨äº†setMaximumPoolSize()ï¼‰
 * 2. çº¿ç¨‹æ± è¢«stop
 * 3. çº¿ç¨‹æ± è¢«shutdownï¼Œå¹¶ä¸”workQueueç©ºäº†
 * 4. çº¿ç¨‹ç­‰å¾…ä»»åŠ¡è¶…æ—¶
 */
private Runnable getTask() {
    //æ ‡è®°ä¸Šæ¬¡æ‰§è¡Œpoll() æ˜¯å¦è¶…æ—¶
    boolean timedOut = false;

    retry:
    for (;;) {
        int c = ctl.get();
        int rs = runStateOf(c);
 
        /**
         * åˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³ä»workQueueä¸­è·å–ä»»åŠ¡çš„æ¡ä»¶
         * 1. å¯¹çº¿ç¨‹æ± çŠ¶æ€çš„åˆ¤æ–­ï¼Œä¸¤ç§æƒ…å†µä¼šworkerCount-1ï¼Œå¹¶ä¸”è¿”å›null
         *   a. çº¿ç¨‹æ± çŠ¶æ€ä¸ºshutdownï¼Œä¸”workQueueä¸ºç©ºï¼ˆåæ˜ äº†shutdownçŠ¶æ€çš„çº¿ç¨‹æ± è¿˜æ˜¯è¦æ‰§è¡ŒworkQueueä¸­å‰©ä½™çš„ä»»åŠ¡çš„ï¼‰
         *   b. çº¿ç¨‹æ± çŠ¶æ€ä¸ºstopï¼ˆshutdownNow()ä¼šå¯¼è‡´å˜æˆSTOPï¼‰ï¼ˆæ­¤æ—¶ä¸ç”¨è€ƒè™‘workQueueçš„æƒ…å†µï¼‰
         */
        if (rs >= SHUTDOWN && (rs >= STOP || workQueue.isEmpty())) {
            decrementWorkerCount(); //å¾ªç¯çš„CASå‡å°‘workeræ•°é‡ï¼Œç›´åˆ°æˆåŠŸ
            return null;
        }
        // æ˜¯å¦éœ€è¦å®šæ—¶ä»workQueueä¸­è·å–
        boolean timed;

        //åˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³ä»workQueueä¸­è·å–ä»»åŠ¡çš„æ¡ä»¶
        //2. çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡maximumPoolSize æˆ– è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶
        //  a çº¿ç¨‹æ•°é‡è¶…è¿‡maximumPoolSizeå¯èƒ½æ˜¯çº¿ç¨‹æ± åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨äº†setMaximumPoolSize()è¢«æ”¹å˜äº†å¤§å°ï¼Œ
        //    å¦åˆ™å·²ç»addWorker()æˆåŠŸä¸ä¼šè¶…è¿‡maximumPoolSize
        //  b å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡>corePoolSizeï¼Œæ‰ä¼šæ£€æŸ¥æ˜¯å¦è·å–ä»»åŠ¡è¶…æ—¶ï¼Œè¿™ä¹Ÿä½“ç°äº†å½“çº¿ç¨‹æ•°é‡è¾¾åˆ°maximumPoolSizeåï¼Œ
        //   å¦‚æœä¸€ç›´æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œä¼šé€æ¸ç»ˆæ­¢workerçº¿ç¨‹ç›´åˆ°corePoolSize
        for (;;) {
            int wc = workerCountOf(c);
            //allowCoreThreadTimeOuté»˜è®¤ä¸ºfalse
            //å¦‚æœallowCoreThreadTimeOutä¸ºtrueï¼Œè¯´æ˜corePoolSizeå’Œmaximuméƒ½éœ€è¦å®šæ—¶
            timed = allowCoreThreadTimeOut || wc > corePoolSize; 
            //å¦‚æœå½“å‰æ‰§è¡Œçº¿ç¨‹æ•°<maximumPoolSizeï¼Œå¹¶ä¸”timedOut å’Œ timed ä»»ä¸€ä¸ºfalseï¼Œè·³å‡ºå¾ªç¯ï¼Œå¼€å§‹ä»workQueueè·å–ä»»åŠ¡
            if (wc <= maximumPoolSize && ! (timedOut && timed))
                break;
            /**
             * å¦‚æœåˆ°äº†è¿™ä¸€æ­¥ï¼Œè¯´æ˜è¦ä¹ˆçº¿ç¨‹æ•°é‡è¶…è¿‡äº†maximumPoolSizeï¼ˆå¯èƒ½maximumPoolSizeè¢«ä¿®æ”¹äº†ï¼‰
             * è¦ä¹ˆæ—¢éœ€è¦è®¡æ—¶timed==trueï¼Œä¹Ÿè¶…æ—¶äº†timedOut==true
             * workeræ•°é‡-1ï¼Œå‡ä¸€æ‰§è¡Œä¸€æ¬¡å°±è¡Œäº†ï¼Œç„¶åè¿”å›nullï¼Œåœ¨runWorker()ä¸­ä¼šæœ‰é€»è¾‘å‡å°‘workerçº¿ç¨‹
             * å¦‚æœæœ¬æ¬¡å‡ä¸€å¤±è´¥ï¼Œç»§ç»­å†…å±‚å¾ªç¯å†æ¬¡å°è¯•å‡ä¸€
             */
            if (compareAndDecrementWorkerCount(c))
                return null;
             
            //å¦‚æœå‡æ•°é‡å¤±è´¥ï¼Œå†æ¬¡è¯»å–ctl
            c = ctl.get();  // Re-read ctl
             
            //å¦‚æœçº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œç»§ç»­å¤–å±‚å¾ªç¯
            //å¦‚æœçŠ¶æ€æ²¡å˜ï¼Œç»§ç»­å†…å±‚å¾ªç¯
            if (runStateOf(c) != rs)
                continue retry;
        }
 
        try {
            // 2. å¦‚æœæ»¡è¶³è·å–ä»»åŠ¡æ¡ä»¶ï¼Œæ ¹æ®æ˜¯å¦éœ€è¦å®šæ—¶è·å–è°ƒç”¨ä¸åŒæ–¹æ³•ï¼š
            //    Aã€workQueue.poll()ï¼š
            //       ä½¿ç”¨  LockSupport.parkNanos(this, nanosTimeout) æŒ‚èµ·ä¸€æ®µæ—¶é—´ï¼Œinterrupt()æ—¶ä¸ä¼šæŠ›å¼‚å¸¸ï¼Œä½†ä¼šæœ‰ä¸­æ–­å“åº”
            //       å¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…ï¼Œé˜»å¡é˜Ÿåˆ—è¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡ï¼Œè¿”å›null
            //    Bã€workQueue.take()ï¼š
            //       ä½¿ç”¨ LockSupport.park(this) æŒ‚èµ·ï¼Œinterrupt()æ—¶ä¸ä¼šæŠ›å¼‚å¸¸ï¼Œä½†ä¼šæœ‰ä¸­æ–­å“åº”
            //       å¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç­‰å¾…ï¼›å½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡åŠ å…¥æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œtakeæ–¹æ³•è¿”å›ä»»åŠ¡
            Runnable r = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :    //å¤§äºcorePoolSize
                workQueue.take();                                        //å°äºç­‰äºcorePoolSize
             
            //å¦‚è·å–åˆ°äº†ä»»åŠ¡å°±è¿”å›
            if (r != null)
                return r;
             
            //æ²¡æœ‰è¿”å›ï¼Œè¯´æ˜è¶…æ—¶ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡å†…å±‚å¾ªç¯æ—¶ä¼šè¿›å…¥worker countå‡ä¸€çš„æ­¥éª¤
            timedOut = true;
        } 
        /**
          * blockingQueueçš„take()é˜»å¡ä½¿ç”¨LockSupport.park(this)è¿›å…¥waitçŠ¶æ€çš„ï¼Œ
          * å¯¹LockSupport.park(this)è¿›è¡Œinterruptä¸ä¼šæŠ›å¼‚å¸¸ï¼Œä½†è¿˜æ˜¯ä¼šæœ‰ä¸­æ–­å“åº”
          * ä½†AQSçš„ConditionObjectçš„await()å¯¹ä¸­æ–­çŠ¶æ€åšäº†åˆ¤æ–­ï¼Œä¼šæŠ¥å‘Šä¸­æ–­çŠ¶æ€ reportInterruptAfterWait(interruptMode)
          * å°±ä¼šä¸ŠæŠ›InterruptedExceptionï¼Œåœ¨æ­¤å¤„æ•è·ï¼Œé‡æ–°å¼€å§‹å¾ªç¯
          * å¦‚æœæ˜¯ç”±äºshutdown()ç­‰æ“ä½œå¯¼è‡´çš„ç©ºé—²workerä¸­æ–­å“åº”ï¼Œåœ¨å¤–å±‚å¾ªç¯åˆ¤æ–­çŠ¶æ€æ—¶ï¼Œå¯èƒ½return null
          */
        catch (InterruptedException retry) { 
            timedOut = false; //å“åº”ä¸­æ–­ï¼Œé‡æ–°å¼€å§‹ï¼Œä¸­æ–­çŠ¶æ€ä¼šè¢«æ¸…é™¤
        }
    }
}
```
<!-- 
1ã€é¦–å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥æ»¡è¶³ä»workQueueä¸­è·å–ä»»åŠ¡çš„æ¡ä»¶ï¼Œä¸æ»¡è¶³return null
    Aã€çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ»¡è¶³ï¼š
        ï¼ˆaï¼‰shutdownçŠ¶æ€ + workQueueä¸ºç©º æˆ– stopçŠ¶æ€ï¼Œéƒ½ä¸æ»¡è¶³ï¼Œå› ä¸ºè¢«shutdownåè¿˜æ˜¯è¦æ‰§è¡ŒworkQueueå‰©ä½™çš„ä»»åŠ¡ï¼Œä½†workQueueä¹Ÿä¸ºç©ºï¼Œå°±å¯ä»¥é€€å‡ºäº†
        ï¼ˆbï¼‰stopçŠ¶æ€ï¼ŒshutdownNow()æ“ä½œä¼šä½¿çº¿ç¨‹æ± è¿›å…¥stopï¼Œæ­¤æ—¶ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼ŒworkQueueä¸­çš„ä»»åŠ¡ä¹Ÿä¸æ‰§è¡Œäº†ï¼Œæ•…return nullè¿”å›
    Bã€çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡maximumPoolSize æˆ– è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶
        ï¼ˆaï¼‰çº¿ç¨‹æ•°é‡è¶…è¿‡maximumPoolSizeå¯èƒ½æ˜¯çº¿ç¨‹æ± åœ¨è¿è¡Œæ—¶è¢«è°ƒç”¨äº†setMaximumPoolSize()è¢«æ”¹å˜äº†å¤§å°ï¼Œå¦åˆ™å·²ç»addWorker()æˆåŠŸä¸ä¼šè¶…è¿‡maximumPoolSize
        ï¼ˆbï¼‰å¦‚æœ å½“å‰çº¿ç¨‹æ•°é‡>corePoolSizeï¼Œæ‰ä¼šæ£€æŸ¥æ˜¯å¦è·å–ä»»åŠ¡è¶…æ—¶ï¼Œè¿™ä¹Ÿä½“ç°äº†å½“çº¿ç¨‹æ•°é‡è¾¾åˆ°maximumPoolSizeåï¼Œå¦‚æœä¸€ç›´æ²¡æœ‰æ–°ä»»åŠ¡ï¼Œä¼šé€æ¸ç»ˆæ­¢workerçº¿ç¨‹ç›´åˆ°corePoolSize
2ã€å¦‚æœæ»¡è¶³è·å–ä»»åŠ¡æ¡ä»¶ï¼Œæ ¹æ®æ˜¯å¦éœ€è¦å®šæ—¶è·å–è°ƒç”¨ä¸åŒæ–¹æ³•ï¼š
    Aã€workQueue.poll()ï¼šå¦‚æœåœ¨keepAliveTimeæ—¶é—´å†…ï¼Œé˜»å¡é˜Ÿåˆ—è¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡ï¼Œè¿”å›null
    Bã€workQueue.take()ï¼šå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç­‰å¾…ï¼›å½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡åŠ å…¥æ—¶ï¼Œçº¿ç¨‹è¢«å”¤é†’ï¼Œtakeæ–¹æ³•è¿”å›ä»»åŠ¡
3ã€åœ¨é˜»å¡ä»workQueueä¸­è·å–ä»»åŠ¡æ—¶ï¼Œå¯ä»¥è¢«interrupt()ä¸­æ–­ï¼Œä»£ç ä¸­æ•è·äº†InterruptedExceptionï¼Œé‡ç½®timedOutä¸ºåˆå§‹å€¼falseï¼Œå†æ¬¡æ‰§è¡Œç¬¬1æ­¥ä¸­çš„åˆ¤æ–­ï¼Œæ»¡è¶³å°±ç»§ç»­è·å–ä»»åŠ¡ï¼Œä¸æ»¡è¶³return nullï¼Œä¼šè¿›å…¥workeré€€å‡ºçš„æµç¨‹ -->

### 4.6 processWorkerExit()
```java
private void processWorkerExit(Worker w, boolean completedAbruptly) {
    /**
     * 1. åˆ¤æ–­æ˜¯å¦æ˜¯çªç„¶ä¸­æ­¢ï¼Œä»¥å†³å®šæ˜¯å¦workerçº¿ç¨‹æ•°é‡éœ€è¦-1
     * å¦‚æœæ˜¯çªç„¶ç»ˆæ­¢ï¼Œè¯´æ˜æ˜¯taskæ‰§è¡Œæ—¶å¼‚å¸¸æƒ…å†µå¯¼è‡´ï¼Œå³run()æ–¹æ³•æ‰§è¡Œæ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆæ­£åœ¨å·¥ä½œçš„workerçº¿ç¨‹æ•°é‡éœ€è¦-1
     * å¦‚æœä¸æ˜¯çªç„¶ç»ˆæ­¢ï¼Œè¯´æ˜æ˜¯workerçº¿ç¨‹æ²¡æœ‰taskå¯æ‰§è¡Œäº†ï¼Œä¸ç”¨-1ï¼Œå› ä¸ºå·²ç»åœ¨getTask()æ–¹æ³•ä¸­-1äº†
     */
    if (completedAbruptly) 
        decrementWorkerCount();
 
    /**
     * 2.ä»Workers Setä¸­ç§»é™¤worker
     */
    final ReentrantLock mainLock = this.mainLock;
    mainLock.lock();
    try {
        //æŠŠworkerçš„å®Œæˆä»»åŠ¡æ•°åŠ åˆ°çº¿ç¨‹æ± çš„å®Œæˆä»»åŠ¡æ•°
        completedTaskCount += w.completedTasks; 
        //ä»HashSet<Worker>ä¸­ç§»é™¤
        workers.remove(w); 
    } finally {
        mainLock.unlock();
    }
 
    /**
     * 3ã€åœ¨å¯¹çº¿ç¨‹æ± æœ‰è´Ÿæ•ˆç›Šçš„æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦â€œå°è¯•ç»ˆæ­¢â€çº¿ç¨‹æ± 
     * ä¸»è¦æ˜¯åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦æ»¡è¶³ç»ˆæ­¢çš„çŠ¶æ€
     * å¦‚æœçŠ¶æ€æ»¡è¶³ï¼Œä½†è¿˜æœ‰çº¿ç¨‹æ± è¿˜æœ‰çº¿ç¨‹ï¼Œå°è¯•å¯¹å…¶å‘å‡ºä¸­æ–­å“åº”ï¼Œä½¿å…¶èƒ½è¿›å…¥é€€å‡ºæµç¨‹
     * æ²¡æœ‰çº¿ç¨‹äº†ï¼Œæ›´æ–°çŠ¶æ€ä¸ºtidying->terminated
     */
    tryTerminate();
 
    /**
     * 4ã€æ˜¯å¦éœ€è¦å¢åŠ workerçº¿ç¨‹
     * çº¿ç¨‹æ± çŠ¶æ€æ˜¯running æˆ– shutdown
     * å¦‚æœå½“å‰çº¿ç¨‹æ˜¯çªç„¶ç»ˆæ­¢çš„ï¼ŒaddWorker()
     * å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯çªç„¶ç»ˆæ­¢çš„ï¼Œä½†å½“å‰çº¿ç¨‹æ•°é‡ < è¦ç»´æŠ¤çš„çº¿ç¨‹æ•°é‡ï¼ŒaddWorker()
     * æ•…å¦‚æœè°ƒç”¨çº¿ç¨‹æ± shutdown()ï¼Œç›´åˆ°workQueueä¸ºç©ºå‰ï¼Œçº¿ç¨‹æ± éƒ½ä¼šç»´æŒcorePoolSizeä¸ªçº¿ç¨‹ï¼Œç„¶åå†é€æ¸é”€æ¯è¿™corePoolSizeä¸ªçº¿ç¨‹
     */
    int c = ctl.get();
    //å¦‚æœçŠ¶æ€æ˜¯runningã€shutdownï¼Œå³tryTerminate()æ²¡æœ‰æˆåŠŸç»ˆæ­¢çº¿ç¨‹æ± ï¼Œå°è¯•å†æ·»åŠ ä¸€ä¸ªworker
    if (runStateLessThan(c, STOP)) {
        //ä¸æ˜¯çªç„¶å®Œæˆçš„ï¼Œå³æ²¡æœ‰taskä»»åŠ¡å¯ä»¥è·å–è€Œå®Œæˆçš„ï¼Œè®¡ç®—minï¼Œå¹¶æ ¹æ®å½“å‰workeræ•°é‡åˆ¤æ–­æ˜¯å¦éœ€è¦addWorker()
        if (!completedAbruptly) {
            // allowCoreThreadTimeOuté»˜è®¤ä¸ºfalseï¼Œå³miné»˜è®¤ä¸ºcorePoolSize
            int min = allowCoreThreadTimeOut ? 0 : corePoolSize;
             
            //å¦‚æœminä¸º0ï¼Œå³ä¸éœ€è¦ç»´æŒæ ¸å¿ƒçº¿ç¨‹æ•°é‡ï¼Œä¸”workQueueä¸ä¸ºç©ºï¼Œè‡³å°‘ä¿æŒä¸€ä¸ªçº¿ç¨‹
            if (min == 0 && ! workQueue.isEmpty())
                min = 1;
             
            //å¦‚æœçº¿ç¨‹æ•°é‡å¤§äºæœ€å°‘æ•°é‡ï¼Œç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¸‹é¢è‡³å°‘è¦addWorkerä¸€ä¸ª
            if (workerCountOf(c) >= min)
                return;
        }
        
        //æ·»åŠ ä¸€ä¸ªworker
        //åªè¦workeræ˜¯completedAbruptlyçªç„¶ç»ˆæ­¢çš„ï¼Œæˆ–è€…çº¿ç¨‹æ•°é‡å°äºè¦ç»´æŠ¤çš„æ•°é‡ï¼Œå°±æ–°æ·»ä¸€ä¸ªworkerçº¿ç¨‹ï¼Œå³ä½¿æ˜¯shutdownçŠ¶æ€
        addWorker(null, false);
    }
}
```

## çº¿ç¨‹æ± å…³é—­

çº¿ç¨‹æ± å…³é—­ä¾èµ–äºä¸¤ä¸ªæ–¹æ³•

(1) shutdown() : ä¸ä¼šç«‹å³ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œè€Œæ˜¯è¦ç­‰æ‰€æœ‰ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œåæ‰ç»ˆæ­¢ï¼Œä½†å†ä¹Ÿä¸ä¼šæ¥å—æ–°çš„ä»»åŠ¡

(2) shutdownNow() : ç«‹å³ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œå¹¶å°è¯•æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”æ¸…ç©ºä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—ï¼Œè¿”å›å°šæœªæ‰§è¡Œçš„ä»»åŠ¡

é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªçœ‹

### shutdown() æ–¹æ³•

```java
    public void shutdown() {
        final ReentrantLock mainLock = this.mainLock;
        //æ‰“é”
        mainLock.lock();
        try {
            //ç›‘æµ‹è°ƒç”¨æ–¹èƒ½æ­£å¸¸å…³é—­çº¿ç¨‹ï¼Œä¸€èˆ¬ä¸éœ€ç†ä¼š
            checkShutdownAccess();
            //åŸå­æ€§çš„ä¿®æ”¹çº¿ç¨‹æ± çš„çŠ¶æ€ä¸ºSTOPçŠ¶æ€
            advanceRunState(SHUTDOWN);
            //éå†çº¿ç¨‹æ± é‡Œçš„æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼Œç„¶åè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•
            interruptIdleWorkers();
            //ä¸“é—¨ç”¨äºScheduledThreadPoolExecutorçš„å¤„ç†æ–¹æ³•
            onShutdown();
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
    }

    private void advanceRunState(int targetState) {
        //ä¸€ç›´åœ¨å¾ªç¯è®©ctlå‘ç”Ÿæ›´æ”¹,åªè¦ä¸æˆåŠŸå°±ä¸€ç›´é‡è¯•
        for (;;) {
            int c = ctl.get();
            if (runStateAtLeast(c, targetState) ||
                ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))))
                break;
        }
    }

    private void interruptIdleWorkers() {
        interruptIdleWorkers(false);
    }

    //æ–¹æ³•è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œå‚æ•°onlyOneå†³å®šæ˜¯ä¸æ˜¯å…¨éƒ¨ä¸­æ–­æˆ–è€…å°±ä¸­æ–­ä¸€ä¸ª
    private void interruptIdleWorkers(boolean onlyOne) {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers) {
                Thread t = w.thread;
                if (!t.isInterrupted() && w.tryLock()) {
                    try {
                        t.interrupt();
                    } catch (SecurityException ignore) {
                    } finally {
                        w.unlock();
                    }
                }
                if (onlyOne)
                    break;
            }
        } finally {
            mainLock.unlock();
        }
    }

    final void tryTerminate() {
        //ä¸€ç›´é‡è¯•å»æ›´æ”¹çº¿ç¨‹æ± çŠ¶æ€(-> TERMINATED)
        for (;;) {
            int c = ctl.get();
            /**
             * çº¿ç¨‹æ± æ˜¯å¦éœ€è¦ç»ˆæ­¢
             * å¦‚æœä»¥ä¸‹3ä¸­æƒ…å†µä»»ä¸€ä¸ºtrueï¼Œreturnï¼Œä¸è¿›è¡Œç»ˆæ­¢
             * 1ã€è¿˜åœ¨è¿è¡ŒçŠ¶æ€
             * 2ã€çŠ¶æ€æ˜¯TIDYINGã€æˆ– TERMINATEDï¼Œå·²ç»ç»ˆæ­¢è¿‡äº†
             * 3ã€SHUTDOWN ä¸” workQueueä¸ä¸ºç©º
             */
            if (isRunning(c) ||
                runStateAtLeast(c, TIDYING) ||
                (runStateOf(c) == SHUTDOWN && ! workQueue.isEmpty()))
                return;
            /**
             * åªæœ‰shutdownçŠ¶æ€ ä¸” workQueueä¸ºç©ºï¼Œæˆ–è€… stopçŠ¶æ€èƒ½æ‰§è¡Œåˆ°è¿™ä¸€æ­¥
             * å¦‚æœæ­¤æ—¶çº¿ç¨‹æ± è¿˜æœ‰çº¿ç¨‹ï¼ˆæ­£åœ¨è¿è¡Œä»»åŠ¡ï¼Œæ­£åœ¨ç­‰å¾…ä»»åŠ¡ï¼‰
             * ä¸­æ–­å”¤é†’ä¸€ä¸ªæ­£åœ¨ç­‰ä»»åŠ¡çš„ç©ºé—²worker
             * å”¤é†’åå†æ¬¡åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€ï¼Œä¼šreturn nullï¼Œè¿›å…¥processWorkerExit()æµç¨‹
             */
            if (workerCountOf(c) != 0) { // Eligible to terminate
                //ä¸­æ–­workersé›†åˆä¸­çš„ç©ºé—²ä»»åŠ¡ï¼Œå‚æ•°ä¸ºtrueï¼Œåªä¸­æ–­ä¸€ä¸ª
                interruptIdleWorkers(ONLY_ONE);
                return;
            }

            //å¦‚æœçŠ¶æ€æ˜¯SHUTDOWNï¼ŒworkQueueä¹Ÿä¸ºç©ºäº†ï¼Œæ­£åœ¨è¿è¡Œçš„workerä¹Ÿæ²¡æœ‰äº†ï¼Œå¼€å§‹terminated
            final ReentrantLock mainLock = this.mainLock;
            mainLock.lock();
            try {
                if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) {
                    try {
                        terminated();
                    } finally {
                        //å°†çº¿ç¨‹æ± çš„ctlå˜æˆTERMINATED
                        ctl.set(ctlOf(TERMINATED, 0));
                        //å”¤é†’è°ƒç”¨äº† ç­‰å¾…çº¿ç¨‹æ± ç»ˆæ­¢çš„çº¿ç¨‹ awaitTermination() 
                        termination.signalAll();
                    }
                    return;
                }
            } finally {
                mainLock.unlock();
            }
            // å¦‚æœä¸Šé¢çš„CASåˆ¤æ–­falseï¼Œå†æ¬¡å¾ªç¯
        }
    }
```

### shutdownNow()
```java
    public List<Runnable> shutdownNow() {
        List<Runnable> tasks;
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            checkShutdownAccess();
            //ä½¿ç”¨casæ›´æ”¹çº¿ç¨‹æ± çŠ¶æ€
            advanceRunState(STOP);
            //ä¸ç®¡æ€ä¹ˆçš„ï¼Œç«‹é©¬ä¸­æ–­çº¿ç¨‹
            interruptWorkers();
            //è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œçš„taskæŠ½å‡ºæ¥
            tasks = drainQueue();
        } finally {
            mainLock.unlock();
        }
        tryTerminate();
        return tasks;
    }

    private void interruptWorkers() {
        final ReentrantLock mainLock = this.mainLock;
        mainLock.lock();
        try {
            for (Worker w : workers)
                w.interruptIfStarted();
        } finally {
            mainLock.unlock();
        }
    }

    private List<Runnable> drainQueue() {
        BlockingQueue<Runnable> q = workQueue;
        ArrayList<Runnable> taskList = new ArrayList<Runnable>();
        q.drainTo(taskList);
        //å¦‚æœworkQueueæ˜¯æ˜¯å»¶æ—¶é˜Ÿåˆ—æˆ–è€…å…¶ä»–ç±»å‹çš„é˜»å¡é˜Ÿåˆ—
        //å¯èƒ½ä¼šå‘ç”ŸdrainToæ–¹æ³•è°ƒç”¨å®Œä¹‹åæ²¡ä»€ä¹ˆä½œç”¨ï¼Œé‚£ä¹ˆå°±åªèƒ½ä¸€ä¸ªä¸€ä¸ªæ¥äº†
        if (!q.isEmpty()) {
            for (Runnable r : q.toArray(new Runnable[0])) {
                if (q.remove(r))
                    taskList.add(r);
            }
        }
        return taskList;
    }

```

## é˜»å¡é˜Ÿåˆ—

åœ¨çº¿ç¨‹æ± çš„æ„é€ å‡½æ•°é‡Œï¼Œæœ‰ä¸€ä¸ªå‚é‡æ˜¯BlockingQueue,è¿™ä¸ªæ˜¯å­˜æ”¾taskçš„ä¸€ç§é˜»å¡é˜Ÿåˆ—ã€‚

æ¥ä¸‹æ¥å°±ç®€å•ä»‹ç»jdkä¸­æä¾›çš„å‡ ç§é˜Ÿåˆ—(æ­¤é˜Ÿåˆ—çš„æºç åˆ†æè¯·æŸ¥çœ‹é›†åˆæºç åˆ†æç¯‡ï¼Œæ­¤å¤„ä¸å†è¿‡å¤šæè¿°)

(1)ArrayBlockingQueueï¼šåŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼›

(2)LinkedBlockingQueneï¼šåŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºä»»åŠ¡ï¼Œååé‡é€šå¸¸è¦é«˜äºArrayBlockingQueneï¼›

(3)SynchronousQueneï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äº(2)

(4)priorityBlockingQueneï¼šå…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼›

## æ‹’ç»ç­–ç•¥

åœ¨çº¿ç¨‹æ± çš„æ„é€ å‡½æ•°é‡Œï¼Œæœ‰ä¸€ä¸ªå‚é‡æ˜¯RejectHandle

å½“çº¿ç¨‹æ± çš„ä»»åŠ¡ç¼“å­˜é˜Ÿåˆ—å·²æ»¡å¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°maximumPoolSizeï¼Œå¦‚æœè¿˜æœ‰ä»»åŠ¡åˆ°æ¥å°±ä¼šé‡‡å–ä»»åŠ¡æ‹’ç»ç­–ç•¥

æ‰€æœ‰çš„æ‹’ç»ç­–ç•¥å®ç°ç±»éƒ½ä½œä¸ºThreadPoolExecutorçš„å†…éƒ¨ç±»

```java
    //ç”±è°ƒç”¨çº¿ç¨‹å¤„ç†è¯¥ä»»åŠ¡
    public static class CallerRunsPolicy implements RejectedExecutionHandler {
        
        public CallerRunsPolicy() { }
        //çº¿ç¨‹è‡ªå·±çš„äº‹æƒ…è‡ªå·±åš
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                r.run();
            }
        }
    }

    //ä¸¢å¼ƒä»»åŠ¡å¹¶æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸ã€‚
    public static class AbortPolicy implements RejectedExecutionHandler {
        
        public AbortPolicy() { }

        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            throw new RejectedExecutionException("Task " + r.toString() +
                                                 " rejected from " +
                                                 e.toString());
        }
    }

    //ä¹Ÿæ˜¯ä¸¢å¼ƒä»»åŠ¡ï¼Œä½†æ˜¯ä¸æŠ›å‡ºå¼‚å¸¸ã€‚
    public static class DiscardPolicy implements RejectedExecutionHandler {

        public DiscardPolicy() { }

        //ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œå¾ˆéªšæ°”ï¼Œä»æœªè§è¿‡å¦‚æ­¤åšé¢œæ— è€»çš„ä»£ç 
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
        
        }
    }

    //ä¸¢å¼ƒé˜Ÿåˆ—æœ€å‰é¢çš„ä»»åŠ¡ï¼Œç„¶åé‡æ–°å°è¯•æ‰§è¡Œä»»åŠ¡ï¼ˆé‡å¤æ­¤è¿‡ç¨‹ï¼‰
    public static class DiscardOldestPolicy implements RejectedExecutionHandler {

        public DiscardOldestPolicy() { }

        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            if (!e.isShutdown()) {
                e.getQueue().poll();
                e.execute(r);
            }
        }
    }
```

## ThreadPoolExecutorç±»å’ŒJDKæä¾›çš„å››ä¸ªçº¿ç¨‹æ± å…³ç³»

```java
    //å¯ä»¥ç›´æ¥ä½¿ç”¨jdkå¸®æˆ‘ä»¬é…å¥½äº†çš„é»˜è®¤çš„çº¿ç¨‹æ± 
    //å†™æ³•éƒ½æ˜¯Executors.xxx()
    //åº•å±‚éƒ½æ˜¯è°ƒç”¨ThreadPoolExecutorçš„æ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸åŒè€Œå·²
    ExecutorService xxx = Executors.newCachedThreadPool();
```
(1)newCachedThreadPoolåˆ›å»ºä¸€ä¸ªå¯ç¼“å­˜çº¿ç¨‹æ± ï¼Œå¦‚æœçº¿ç¨‹æ± é•¿åº¦è¶…è¿‡å¤„ç†éœ€è¦ï¼Œå¯çµæ´»å›æ”¶ç©ºé—²çº¿ç¨‹ï¼Œè‹¥æ— å¯å›æ”¶ï¼Œåˆ™æ–°å»ºçº¿ç¨‹ã€‚

(2)newFixedThreadPool åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶çº¿ç¨‹æœ€å¤§å¹¶å‘æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚

(3)newScheduledThreadPool åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œã€‚

(4)newSingleThreadExecutor åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šé¡ºåº(FIFO, LIFO, ä¼˜å…ˆçº§)æ‰§è¡Œã€‚

ç„¶é¹…ï¼ï¼ï¼æä¸å»ºè®®ä½¿ç”¨æ­¤æ–¹å¼å»ºç«‹çº¿ç¨‹æ± ï¼Œä¸å°å¿ƒå°±ä¼šæ·Œå‘ï¼Œä¸€äº›é»˜è®¤çš„é…ç½®å¯¹ä½¿ç”¨è€…ä¸é€æ˜ï¼Œä½¿ç”¨ThreadPoolExecutorç›´æ¥è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œæ¸…æ™°ï¼Œæ˜ç¡®ï¼Œå‘å°‘ã€‚

æ¯”å¦‚ï¼š

1)FixedThreadPool å’Œ SingleThreadPool: å…è®¸çš„è¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMã€‚

2)CachedThreadPool å’Œ ScheduledThreadPool: å…è®¸çš„åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚



















