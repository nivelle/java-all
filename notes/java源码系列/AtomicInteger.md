ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## é—®é¢˜

ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯åŸå­æ“ä½œï¼Ÿ

ï¼ˆ2ï¼‰åŸå­æ“ä½œå’Œæ•°æ®åº“çš„ACIDæœ‰å•¥å…³ç³»ï¼Ÿ

ï¼ˆ3ï¼‰AtomicIntegeræ˜¯æ€ä¹ˆå®ç°åŸå­æ“ä½œçš„ï¼Ÿ

ï¼ˆ4ï¼‰AtomicIntegeræ˜¯æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ

## ç®€ä»‹

AtomicIntegeræ˜¯javaå¹¶å‘åŒ…ä¸‹é¢æä¾›çš„åŸå­ç±»ï¼Œä¸»è¦æ“ä½œçš„æ˜¯intç±»å‹çš„æ•´å‹ï¼Œé€šè¿‡è°ƒç”¨åº•å±‚Unsafeçš„CASç­‰æ–¹æ³•å®ç°åŸå­æ“ä½œã€‚

è¿˜è®°å¾—Unsafeå—ï¼Ÿç‚¹å‡»é“¾æ¥ç›´è¾¾ã€[æ­»ç£• javaé­”æ³•ç±»ä¹‹Unsafeè§£æ](https://mp.weixin.qq.com/s/0s-u-MysppIaIHVrshp9fA)ã€‘

## åŸå­æ“ä½œ

åŸå­æ“ä½œæ˜¯æŒ‡ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œä¸­é—´ä¸ä¼šæœ‰ä»»ä½•çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

åŸå­æ“ä½œå¯ä»¥æ˜¯ä¸€ä¸ªæ­¥éª¤ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªæ“ä½œæ­¥éª¤ï¼Œä½†æ˜¯å…¶é¡ºåºä¸å¯ä»¥è¢«æ‰“ä¹±ï¼Œä¹Ÿä¸å¯ä»¥è¢«åˆ‡å‰²è€Œåªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå°†æ•´ä¸ªæ“ä½œè§†ä½œä¸€ä¸ªæ•´ä½“æ˜¯åŸå­æ€§çš„æ ¸å¿ƒç‰¹å¾ã€‚

æˆ‘ä»¬è¿™é‡Œè¯´çš„åŸå­æ“ä½œä¸æ•°æ®åº“ACIDä¸­çš„åŸå­æ€§ï¼Œç¬”è€…è®¤ä¸ºæœ€å¤§åŒºåˆ«åœ¨äºï¼Œæ•°æ®åº“ä¸­çš„åŸå­æ€§ä¸»è¦è¿ç”¨åœ¨äº‹åŠ¡ä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡ä¹‹å†…çš„æ‰€æœ‰æ›´æ–°æ“ä½œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œäº‹åŠ¡æ˜¯æœ‰å›æ»šæœºåˆ¶çš„ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œè¯´çš„åŸå­æ“ä½œæ˜¯æ²¡æœ‰å›æ»šçš„ï¼Œè¿™æ˜¯æœ€å¤§çš„åŒºåˆ«ã€‚

## æºç åˆ†æ

### ä¸»è¦å±æ€§

```java
// è·å–Unsafeçš„å®ä¾‹
private static final Unsafe unsafe = Unsafe.getUnsafe();
// æ ‡è¯†valueå­—æ®µçš„åç§»é‡
private static final long valueOffset;
// é™æ€ä»£ç å—ï¼Œé€šè¿‡unsafeè·å–valueçš„åç§»é‡
static {
    try {
        valueOffset = unsafe.objectFieldOffset
            (AtomicInteger.class.getDeclaredField("value"));
    } catch (Exception ex) { throw new Error(ex); }
}
// å­˜å‚¨intç±»å‹å€¼çš„åœ°æ–¹ï¼Œä½¿ç”¨volatileä¿®é¥°
private volatile int value;
```

ï¼ˆ1ï¼‰ä½¿ç”¨intç±»å‹çš„valueå­˜å‚¨å€¼ï¼Œä¸”ä½¿ç”¨volatileä¿®é¥°ï¼Œvolatileä¸»è¦æ˜¯ä¿è¯å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹ç«‹å³å¯è§ï¼Œä¸»è¦çš„å®ç°åŸç†æ˜¯å†…å­˜å±éšœï¼Œè¿™é‡Œä¸å±•å¼€æ¥è®²ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚

ï¼ˆ2ï¼‰è°ƒç”¨Unsafeçš„objectFieldOffset()æ–¹æ³•è·å–valueå­—æ®µåœ¨ç±»ä¸­çš„åç§»é‡ï¼Œç”¨äºåé¢CASæ“ä½œæ—¶ä½¿ç”¨ã€‚

### compareAndSet()æ–¹æ³•

```java
public final boolean compareAndSet(int expect, int update) {
    return unsafe.compareAndSwapInt(this, valueOffset, expect, update);
}
// Unsafeä¸­çš„æ–¹æ³•
public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);
```

è°ƒç”¨Unsafe.compareAndSwapInt()æ–¹æ³•å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰å››ä¸ªå‚æ•°ï¼š

ï¼ˆ1ï¼‰æ“ä½œçš„å¯¹è±¡ï¼›

ï¼ˆ2ï¼‰å¯¹è±¡ä¸­å­—æ®µçš„åç§»é‡ï¼›

ï¼ˆ3ï¼‰åŸæ¥çš„å€¼ï¼Œå³æœŸæœ›çš„å€¼ï¼›

ï¼ˆ4ï¼‰è¦ä¿®æ”¹çš„å€¼ï¼›

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œåº•å±‚æ˜¯ä½¿ç”¨C/C++å†™çš„ï¼Œä¸»è¦æ˜¯è°ƒç”¨CPUçš„CASæŒ‡ä»¤æ¥å®ç°ï¼Œå®ƒèƒ½å¤Ÿä¿è¯åªæœ‰å½“å¯¹åº”åç§»é‡å¤„çš„å­—æ®µå€¼æ˜¯æœŸæœ›å€¼æ—¶æ‰æ›´æ–°ï¼Œå³ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ä¸¤æ­¥æ“ä½œï¼š

```java
if(value == expect) {
    value = newValue;
}
```

é€šè¿‡CPUçš„CASæŒ‡ä»¤å¯ä»¥ä¿è¯è¿™ä¸¤æ­¥æ“ä½œæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¯èƒ½æ¯”è¾ƒçš„æ—¶å€™valueå€¼æ˜¯aï¼Œè€Œåˆ°çœŸæ­£èµ‹å€¼çš„æ—¶å€™valueå€¼å¯èƒ½å·²ç»å˜æˆbäº†çš„é—®é¢˜ã€‚

### getAndIncrement()æ–¹æ³•

```java
public final int getAndIncrement() {
    return unsafe.getAndAddInt(this, valueOffset, 1);
}

// Unsafeä¸­çš„æ–¹æ³•
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

    return var5;
}
```

getAndIncrement()æ–¹æ³•åº•å±‚æ˜¯è°ƒç”¨çš„Unsafeçš„getAndAddInt()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š

ï¼ˆ1ï¼‰æ“ä½œçš„å¯¹è±¡ï¼›

ï¼ˆ2ï¼‰å¯¹è±¡ä¸­å­—æ®µçš„åç§»é‡ï¼›

ï¼ˆ3ï¼‰è¦å¢åŠ çš„å€¼ï¼›

æŸ¥çœ‹Unsafeçš„getAndAddInt()æ–¹æ³•çš„æºç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæ˜¯å…ˆè·å–å½“å‰çš„å€¼ï¼Œç„¶åå†è°ƒç”¨compareAndSwapInt()å°è¯•æ›´æ–°å¯¹åº”åç§»é‡å¤„çš„å€¼ï¼Œå¦‚æœæˆåŠŸäº†å°±è·³å‡ºå¾ªç¯ï¼Œå¦‚æœä¸æˆåŠŸå°±å†é‡æ–°å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼Œè¿™å¯ä¸å°±æ˜¯ï¼ˆCAS+è‡ªæ—‹ï¼‰çš„ä¹è§‚é”æœºåˆ¶ä¹ˆ^^

AtomicIntegerä¸­çš„å…¶å®ƒæ–¹æ³•å‡ ä¹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°Unsafeçš„compareAndSwapInt()æ¥ä¿è¯å¯¹valueå€¼æ›´æ–°çš„åŸå­æ€§ã€‚

## æ€»ç»“

ï¼ˆ1ï¼‰AtomicIntegerä¸­ç»´æŠ¤äº†ä¸€ä¸ªä½¿ç”¨volatileä¿®é¥°çš„å˜é‡valueï¼Œä¿è¯å¯è§æ€§ï¼›

ï¼ˆ2ï¼‰AtomicIntegerä¸­çš„ä¸»è¦æ–¹æ³•æœ€ç»ˆå‡ ä¹éƒ½ä¼šè°ƒç”¨åˆ°Unsafeçš„compareAndSwapInt()æ–¹æ³•ä¿è¯å¯¹å˜é‡ä¿®æ”¹çš„åŸå­æ€§ã€‚

## å½©è›‹

ï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆéœ€è¦AtomicIntegerï¼Ÿ

è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```java
public class AtomicIntegerTest {
    private static int count = 0;

    public static void increment() {
        count++;
    }

    public static void main(String[] args) {
        IntStream.range(0, 100)
                .forEach(i->
                        new Thread(()->IntStream.range(0, 1000)
                                .forEach(j->increment())).start());

        // è¿™é‡Œä½¿ç”¨2æˆ–è€…1çœ‹è‡ªå·±çš„æœºå™¨
        // æˆ‘è¿™é‡Œæ˜¯ç”¨runè·‘å¤§äº2æ‰ä¼šé€€å‡ºå¾ªç¯
        // ä½†æ˜¯ç”¨debugè·‘å¤§äº1å°±ä¼šé€€å‡ºå¾ªç¯äº†
        while (Thread.activeCount() > 1) {
            // è®©å‡ºCPU
            Thread.yield();
        }

        System.out.println(count);
    }
}
```

è¿™é‡Œèµ·äº†100ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹countè‡ªå¢1000æ¬¡ï¼Œä½ ä¼šå‘ç°æ¯æ¬¡è¿è¡Œçš„ç»“æœéƒ½ä¸ä¸€æ ·ï¼Œä½†å®ƒä»¬æœ‰ä¸ªå…±åŒç‚¹å°±æ˜¯éƒ½ä¸åˆ°100000æ¬¡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨intæ˜¯æœ‰é—®é¢˜çš„ã€‚

é‚£ä¹ˆï¼Œä½¿ç”¨volatileèƒ½è§£å†³è¿™ä¸ªé—®é¢˜å—ï¼Ÿ

```java
private static volatile int count = 0;

public static void increment() {
    count++;
}
```

ç­”æ¡ˆæ˜¯å¾ˆé—æ†¾çš„ï¼Œvolatileæ— æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºvolatileä»…æœ‰ä¸¤ä¸ªä½œç”¨ï¼š

ï¼ˆ1ï¼‰ä¿è¯å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹å¦ä¸€ä¸ªçº¿ç¨‹ç«‹å³å¯è§ï¼›

ï¼ˆ2ï¼‰ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼›

è¿™é‡Œæœ‰ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œcount++å®é™…ä¸Šæ˜¯ä¸¤æ­¥æ“ä½œï¼Œç¬¬ä¸€æ­¥æ˜¯è·å–countçš„å€¼ï¼Œç¬¬äºŒæ­¥æ˜¯å¯¹å®ƒçš„å€¼åŠ 1ã€‚

ä½¿ç”¨volatileæ˜¯æ— æ³•ä¿è¯è¿™ä¸¤æ­¥ä¸è¢«å…¶å®ƒçº¿ç¨‹è°ƒåº¦æ‰“æ–­çš„ï¼Œæ‰€ä»¥æ— æ³•ä¿è¯åŸå­æ€§ã€‚

è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬ä»Šå¤©è®²çš„AtomicIntegerï¼Œå®ƒçš„è‡ªå¢è°ƒç”¨çš„æ˜¯Unsafeçš„CASå¹¶ä½¿ç”¨è‡ªæ—‹ä¿è¯ä¸€å®šä¼šæˆåŠŸï¼Œå®ƒå¯ä»¥ä¿è¯ä¸¤æ­¥æ“ä½œçš„åŸå­æ€§ã€‚

```java
public class AtomicIntegerTest {
    private static AtomicInteger count = new AtomicInteger(0);

    public static void increment() {
        count.incrementAndGet();
    }

    public static void main(String[] args) {
        IntStream.range(0, 100)
                .forEach(i->
                        new Thread(()->IntStream.range(0, 1000)
                                .forEach(j->increment())).start());

        // è¿™é‡Œä½¿ç”¨2æˆ–è€…1çœ‹è‡ªå·±çš„æœºå™¨
        // æˆ‘è¿™é‡Œæ˜¯ç”¨runè·‘å¤§äº2æ‰ä¼šé€€å‡ºå¾ªç¯
        // ä½†æ˜¯ç”¨debugè·‘å¤§äº1å°±ä¼šé€€å‡ºå¾ªç¯äº†
        while (Thread.activeCount() > 1) {
            // è®©å‡ºCPU
            Thread.yield();
        }

        System.out.println(count);
    }
}
```

è¿™é‡Œæ€»æ˜¯ä¼šæ‰“å°å‡º100000ã€‚


ï¼ˆ2ï¼‰è¯´äº†é‚£ä¹ˆå¤šï¼Œä½ çŸ¥é“AtomicIntegeræœ‰ä»€ä¹ˆç¼ºç‚¹å—ï¼Ÿ

å½“ç„¶å°±æ˜¯è‘—åçš„ABAé—®é¢˜å•¦ï¼Œæˆ‘ä»¬ä¸‹ç« æ¥ç€èŠ^^


---

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚

![qrcode](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaé›†åˆç³»åˆ—/resource/qrcode_ss.jpg)
