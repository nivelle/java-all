ðŸ–•æ¬¢è¿Žå…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸Žå½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

ï¼ˆæ‰‹æœºæ¨ªå±çœ‹æºç æ›´æ–¹ä¾¿ï¼‰

---

## é—®é¢˜

ï¼ˆ1ï¼‰ä»€ä¹ˆæ˜¯ CPU ç¼“å­˜è¡Œï¼Ÿ

ï¼ˆ2ï¼‰ä»€ä¹ˆæ˜¯å†…å­˜å±éšœï¼Ÿ

ï¼ˆ3ï¼‰ä»€ä¹ˆæ˜¯ä¼ªå…±äº«ï¼Ÿ

ï¼ˆ4ï¼‰å¦‚ä½•é¿å…ä¼ªå…±äº«ï¼Ÿ

## CPUç¼“å­˜æž¶æž„

CPU æ˜¯è®¡ç®—æœºçš„å¿ƒè„ï¼Œæ‰€æœ‰è¿ç®—å’Œç¨‹åºæœ€ç»ˆéƒ½è¦ç”±å®ƒæ¥æ‰§è¡Œã€‚

ä¸»å†…å­˜ï¼ˆRAMï¼‰æ˜¯æ•°æ®å­˜æ”¾çš„åœ°æ–¹ï¼ŒCPU å’Œä¸»å†…å­˜ä¹‹é—´æœ‰å¥½å‡ çº§ç¼“å­˜ï¼Œå› ä¸ºå³ä½¿ç›´æŽ¥è®¿é—®ä¸»å†…å­˜ä¹Ÿæ˜¯éžå¸¸æ…¢çš„ã€‚

å¦‚æžœå¯¹ä¸€å—æ•°æ®åšç›¸åŒçš„è¿ç®—å¤šæ¬¡ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œè¿ç®—çš„æ—¶å€™æŠŠå®ƒåŠ è½½åˆ°ç¦» CPU å¾ˆè¿‘çš„åœ°æ–¹å°±æœ‰æ„ä¹‰äº†ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ªçŽ¯è®¡æ•°ï¼Œä½ ä¸æƒ³æ¯æ¬¡å¾ªçŽ¯éƒ½è·‘åˆ°ä¸»å†…å­˜åŽ»å–è¿™ä¸ªæ•°æ®æ¥å¢žé•¿å®ƒå§ã€‚

![ABA](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaå¹¶å‘åŒ…/resource/false-sharing1.png)

è¶Šé è¿‘ CPU çš„ç¼“å­˜è¶Šå¿«ä¹Ÿè¶Šå°ã€‚

æ‰€ä»¥ L1 ç¼“å­˜å¾ˆå°ä½†å¾ˆå¿«ï¼Œå¹¶ä¸”ç´§é ç€åœ¨ä½¿ç”¨å®ƒçš„ CPU å†…æ ¸ã€‚

L2 å¤§ä¸€äº›ï¼Œä¹Ÿæ…¢ä¸€äº›ï¼Œå¹¶ä¸”ä»ç„¶åªèƒ½è¢«ä¸€ä¸ªå•ç‹¬çš„ CPU æ ¸ä½¿ç”¨ã€‚

L3 åœ¨çŽ°ä»£å¤šæ ¸æœºå™¨ä¸­æ›´æ™®éï¼Œä»ç„¶æ›´å¤§ï¼Œæ›´æ…¢ï¼Œå¹¶ä¸”è¢«å•ä¸ªæ’æ§½ä¸Šçš„æ‰€æœ‰ CPU æ ¸å…±äº«ã€‚

æœ€åŽï¼Œä¸»å­˜ä¿å­˜ç€ç¨‹åºè¿è¡Œçš„æ‰€æœ‰æ•°æ®ï¼Œå®ƒæ›´å¤§ï¼Œæ›´æ…¢ï¼Œç”±å…¨éƒ¨æ’æ§½ä¸Šçš„æ‰€æœ‰ CPU æ ¸å…±äº«ã€‚

å½“ CPU æ‰§è¡Œè¿ç®—çš„æ—¶å€™ï¼Œå®ƒå…ˆåŽ» L1 æŸ¥æ‰¾æ‰€éœ€çš„æ•°æ®ï¼Œå†åŽ» L2ï¼Œç„¶åŽæ˜¯ L3ï¼Œæœ€åŽå¦‚æžœè¿™äº›ç¼“å­˜ä¸­éƒ½æ²¡æœ‰ï¼Œæ‰€éœ€çš„æ•°æ®å°±è¦åŽ»ä¸»å†…å­˜æ‹¿ã€‚

èµ°å¾—è¶Šè¿œï¼Œè¿ç®—è€—è´¹çš„æ—¶é—´å°±è¶Šé•¿ã€‚

æ‰€ä»¥å¦‚æžœè¿›è¡Œä¸€äº›å¾ˆé¢‘ç¹çš„è¿ç®—ï¼Œè¦ç¡®ä¿æ•°æ®åœ¨ L1 ç¼“å­˜ä¸­ã€‚

## CPUç¼“å­˜è¡Œ

ç¼“å­˜æ˜¯ç”±ç¼“å­˜è¡Œç»„æˆçš„ï¼Œé€šå¸¸æ˜¯ 64 å­—èŠ‚ï¼ˆå¸¸ç”¨å¤„ç†å™¨çš„ç¼“å­˜è¡Œæ˜¯ 64 å­—èŠ‚çš„ï¼Œæ¯”è¾ƒæ—§çš„å¤„ç†å™¨ç¼“å­˜è¡Œæ˜¯ 32 å­—èŠ‚ï¼‰ï¼Œå¹¶ä¸”å®ƒæœ‰æ•ˆåœ°å¼•ç”¨ä¸»å†…å­˜ä¸­çš„ä¸€å—åœ°å€ã€‚

ä¸€ä¸ª Java çš„ long ç±»åž‹æ˜¯ 8 å­—èŠ‚ï¼Œå› æ­¤åœ¨ä¸€ä¸ªç¼“å­˜è¡Œä¸­å¯ä»¥å­˜ 8 ä¸ª long ç±»åž‹çš„å˜é‡ã€‚

![ABA](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaå¹¶å‘åŒ…/resource/false-sharing2.png)

åœ¨ç¨‹åºè¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œç¼“å­˜æ¯æ¬¡æ›´æ–°éƒ½ä»Žä¸»å†…å­˜ä¸­åŠ è½½è¿žç»­çš„ 64 ä¸ªå­—èŠ‚ã€‚å› æ­¤ï¼Œå¦‚æžœè®¿é—®ä¸€ä¸ª long ç±»åž‹çš„æ•°ç»„æ—¶ï¼Œå½“æ•°ç»„ä¸­çš„ä¸€ä¸ªå€¼è¢«åŠ è½½åˆ°ç¼“å­˜ä¸­æ—¶ï¼Œå¦å¤– 7 ä¸ªå…ƒç´ ä¹Ÿä¼šè¢«åŠ è½½åˆ°ç¼“å­˜ä¸­ã€‚

ä½†æ˜¯ï¼Œå¦‚æžœä½¿ç”¨çš„æ•°æ®ç»“æž„ä¸­çš„é¡¹åœ¨å†…å­˜ä¸­ä¸æ˜¯å½¼æ­¤ç›¸é‚»çš„ï¼Œæ¯”å¦‚é“¾è¡¨ï¼Œé‚£ä¹ˆå°†å¾—ä¸åˆ°å…è´¹ç¼“å­˜åŠ è½½å¸¦æ¥çš„å¥½å¤„ã€‚

ä¸è¿‡ï¼Œè¿™ç§å…è´¹åŠ è½½ä¹Ÿæœ‰ä¸€ä¸ªåå¤„ã€‚è®¾æƒ³å¦‚æžœæˆ‘ä»¬æœ‰ä¸ª long ç±»åž‹çš„å˜é‡ aï¼Œå®ƒä¸æ˜¯æ•°ç»„çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªå•ç‹¬çš„å˜é‡ï¼Œå¹¶ä¸”è¿˜æœ‰å¦å¤–ä¸€ä¸ª long ç±»åž‹çš„å˜é‡ b ç´§æŒ¨ç€å®ƒï¼Œé‚£ä¹ˆå½“åŠ è½½ a çš„æ—¶å€™å°†å…è´¹åŠ è½½ bã€‚

çœ‹èµ·æ¥ä¼¼ä¹Žæ²¡æœ‰ä»€ä¹ˆæ¯›ç—…ï¼Œä½†æ˜¯å¦‚æžœä¸€ä¸ª CPU æ ¸å¿ƒçš„çº¿ç¨‹åœ¨å¯¹ a è¿›è¡Œä¿®æ”¹ï¼Œå¦ä¸€ä¸ª CPU æ ¸å¿ƒçš„çº¿ç¨‹å´åœ¨å¯¹ b è¿›è¡Œè¯»å–ã€‚

å½“å‰è€…ä¿®æ”¹ a æ—¶ï¼Œä¼šæŠŠ a å’Œ b åŒæ—¶åŠ è½½åˆ°å‰è€…æ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ï¼Œæ›´æ–°å®Œ a åŽå…¶å®ƒæ‰€æœ‰åŒ…å« a çš„ç¼“å­˜è¡Œéƒ½å°†å¤±æ•ˆï¼Œå› ä¸ºå…¶å®ƒç¼“å­˜ä¸­çš„ a ä¸æ˜¯æœ€æ–°å€¼äº†ã€‚

è€Œå½“åŽè€…è¯»å– b æ—¶ï¼Œå‘çŽ°è¿™ä¸ªç¼“å­˜è¡Œå·²ç»å¤±æ•ˆäº†ï¼Œéœ€è¦ä»Žä¸»å†…å­˜ä¸­é‡æ–°åŠ è½½ã€‚

è¯·è®°ä½ï¼Œæˆ‘ä»¬çš„ç¼“å­˜éƒ½æ˜¯ä»¥ç¼“å­˜è¡Œä½œä¸ºä¸€ä¸ªå•ä½æ¥å¤„ç†çš„ï¼Œæ‰€ä»¥å¤±æ•ˆ a çš„ç¼“å­˜çš„åŒæ—¶ï¼Œä¹Ÿä¼šæŠŠ b å¤±æ•ˆï¼Œåä¹‹äº¦ç„¶ã€‚

![ABA](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaå¹¶å‘åŒ…/resource/false-sharing3.png)

è¿™æ ·å°±å‡ºçŽ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œb å’Œ a å®Œå…¨ä¸ç›¸å¹²ï¼Œæ¯æ¬¡å´è¦å› ä¸º a çš„æ›´æ–°éœ€è¦ä»Žä¸»å†…å­˜é‡æ–°è¯»å–ï¼Œå®ƒè¢«ç¼“å­˜æœªå‘½ä¸­ç»™æ‹–æ…¢äº†ã€‚

è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„ä¼ªå…±äº«ã€‚

## ä¼ªå…±äº«

å¥½äº†ï¼Œä¸Šé¢ä»‹ç»å®ŒCPUçš„ç¼“å­˜æž¶æž„åŠç¼“å­˜è¡Œæœºåˆ¶ï¼Œä¸‹é¢è¿›å…¥æˆ‘ä»¬çš„æ­£é¢˜â€”â€”ä¼ªå…±äº«ã€‚

å½“å¤šçº¿ç¨‹ä¿®æ”¹äº’ç›¸ç‹¬ç«‹çš„å˜é‡æ—¶ï¼Œå¦‚æžœè¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±ä¼šæ— æ„ä¸­å½±å“å½¼æ­¤çš„æ€§èƒ½ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œå……åˆ†è¯´æ˜Žäº†ä¼ªå…±äº«æ˜¯æ€Žä¹ˆå›žäº‹ã€‚

```java
public class FalseSharingTest {

    public static void main(String[] args) throws InterruptedException {
        testPointer(new Pointer());
    }

    private static void testPointer(Pointer pointer) throws InterruptedException {
        long start = System.currentTimeMillis();
        Thread t1 = new Thread(() -> {
            for (int i = 0; i < 100000000; i++) {
                pointer.x++;
            }
        });

        Thread t2 = new Thread(() -> {
            for (int i = 0; i < 100000000; i++) {
                pointer.y++;
            }
        });

        t1.start();
        t2.start();
        t1.join();
        t2.join();

        System.out.println(System.currentTimeMillis() - start);
        System.out.println(pointer);
    }
}

class Pointer {
    volatile long x;
    volatile long y;
}
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å£°æ˜Žäº†ä¸€ä¸ª Pointer çš„ç±»ï¼Œå®ƒåŒ…å« x å’Œ y ä¸¤ä¸ªå˜é‡ï¼ˆå¿…é¡»å£°æ˜Žä¸ºvolatileï¼Œä¿è¯å¯è§æ€§ï¼Œå…³äºŽå†…å­˜å±éšœçš„ä¸œè¥¿æˆ‘ä»¬åŽé¢å†è®²ï¼‰ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ x è¿›è¡Œè‡ªå¢ž1äº¿æ¬¡ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ y è¿›è¡Œè‡ªå¢ž1äº¿æ¬¡ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œx å’Œ y å®Œå…¨æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä½†æ˜¯æ›´æ–° x çš„æ—¶å€™ä¼šæŠŠå…¶å®ƒåŒ…å« x çš„ç¼“å­˜è¡Œå¤±æ•ˆï¼ŒåŒæ—¶ä¹Ÿå°±å¤±æ•ˆäº† yï¼Œè¿è¡Œè¿™æ®µç¨‹åºè¾“å‡ºçš„æ—¶é—´ä¸º`3890ms`ã€‚

## é¿å…ä¼ªå…±äº«

ä¼ªå…±äº«çš„åŽŸç†æˆ‘ä»¬çŸ¥é“äº†ï¼Œä¸€ä¸ªç¼“å­˜è¡Œæ˜¯ 64 ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ª long ç±»åž‹æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥é¿å…ä¼ªå…±äº«ä¹Ÿå¾ˆç®€å•ï¼Œç¬”è€…æ€»ç»“äº†ä¸‹å¤§æ¦‚æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š

ï¼ˆ1ï¼‰åœ¨ä¸¤ä¸ª long ç±»åž‹çš„å˜é‡ä¹‹é—´å†åŠ  7 ä¸ª long ç±»åž‹

æˆ‘ä»¬æŠŠä¸Šé¢çš„Pointeræ”¹æˆä¸‹é¢è¿™ä¸ªç»“æž„ï¼š

```java
class Pointer {
    volatile long x;
    long p1, p2, p3, p4, p5, p6, p7;
    volatile long y;
}
```

å†æ¬¡è¿è¡Œç¨‹åºï¼Œä¼šå‘çŽ°è¾“å‡ºæ—¶é—´ç¥žå¥‡çš„ç¼©çŸ­ä¸ºäº†`695ms`ã€‚

ï¼ˆ2ï¼‰é‡æ–°åˆ›å»ºè‡ªå·±çš„ long ç±»åž‹ï¼Œè€Œä¸æ˜¯ java è‡ªå¸¦çš„ long

ä¿®æ”¹Pointerå¦‚ä¸‹ï¼š

```java
class Pointer {
    MyLong x = new MyLong();
    MyLong y = new MyLong();
}

class MyLong {
    volatile long value;
    long p1, p2, p3, p4, p5, p6, p7;
}
```

åŒæ—¶æŠŠ `pointer.x++;` ä¿®æ”¹ä¸º `pointer.x.value++;`ï¼ŒæŠŠ `pointer.y++;` ä¿®æ”¹ä¸º `pointer.y.value++;`ï¼Œå†æ¬¡è¿è¡Œç¨‹åºå‘çŽ°æ—¶é—´æ˜¯`724ms`ã€‚

ï¼ˆ3ï¼‰ä½¿ç”¨ @sun.misc.Contended æ³¨è§£ï¼ˆjava8ï¼‰

ä¿®æ”¹ MyLong å¦‚ä¸‹ï¼š

```java
@sun.misc.Contended
class MyLong {
    volatile long value;
}
```

é»˜è®¤ä½¿ç”¨è¿™ä¸ªæ³¨è§£æ˜¯æ— æ•ˆçš„ï¼Œéœ€è¦åœ¨JVMå¯åŠ¨å‚æ•°åŠ ä¸Š`-XX:-RestrictContended`æ‰ä¼šç”Ÿæ•ˆï¼Œï¼Œå†æ¬¡è¿è¡Œç¨‹åºå‘çŽ°æ—¶é—´æ˜¯`718ms`ã€‚

æ³¨æ„ï¼Œä»¥ä¸Šä¸‰ç§æ–¹å¼ä¸­çš„å‰ä¸¤ç§æ˜¯é€šè¿‡åŠ å­—æ®µçš„å½¢å¼å®žçŽ°çš„ï¼ŒåŠ çš„å­—æ®µåˆæ²¡æœ‰åœ°æ–¹ä½¿ç”¨ï¼Œå¯èƒ½ä¼šè¢«jvmä¼˜åŒ–æŽ‰ï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹å¼ã€‚

## æ€»ç»“

ï¼ˆ1ï¼‰CPUå…·æœ‰å¤šçº§ç¼“å­˜ï¼Œè¶ŠæŽ¥è¿‘CPUçš„ç¼“å­˜è¶Šå°ä¹Ÿè¶Šå¿«ï¼›

ï¼ˆ2ï¼‰CPUç¼“å­˜ä¸­çš„æ•°æ®æ˜¯ä»¥ç¼“å­˜è¡Œä¸ºå•ä½å¤„ç†çš„ï¼›

ï¼ˆ3ï¼‰CPUç¼“å­˜è¡Œèƒ½å¸¦æ¥å…è´¹åŠ è½½æ•°æ®çš„å¥½å¤„ï¼Œæ‰€ä»¥å¤„ç†æ•°ç»„æ€§èƒ½éžå¸¸é«˜ï¼›

ï¼ˆ4ï¼‰CPUç¼“å­˜è¡Œä¹Ÿå¸¦æ¥äº†å¼Šç«¯ï¼Œå¤šçº¿ç¨‹å¤„ç†ä¸ç›¸å¹²çš„å˜é‡æ—¶ä¼šç›¸äº’å½±å“ï¼Œä¹Ÿå°±æ˜¯ä¼ªå…±äº«ï¼›

ï¼ˆ5ï¼‰é¿å…ä¼ªå…±äº«çš„ä¸»è¦æ€è·¯å°±æ˜¯è®©ä¸ç›¸å¹²çš„å˜é‡ä¸è¦å‡ºçŽ°åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼›

ï¼ˆ6ï¼‰ä¸€æ˜¯æ¯ä¸¤ä¸ªå˜é‡ä¹‹é—´åŠ ä¸ƒä¸ª long ç±»åž‹ï¼›

ï¼ˆ7ï¼‰äºŒæ˜¯åˆ›å»ºè‡ªå·±çš„ long ç±»åž‹ï¼Œè€Œä¸æ˜¯ç”¨åŽŸç”Ÿçš„ï¼›

ï¼ˆ8ï¼‰ä¸‰æ˜¯ä½¿ç”¨ java8 æä¾›çš„æ³¨è§£ï¼›

## å½©è›‹

javaä¸­æœ‰å“ªäº›ç±»é¿å…äº†ä¼ªå…±äº«çš„å¹²æ‰°å‘¢ï¼Ÿ

è¿˜è®°å¾—æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡çš„ ConcurrentHashMap çš„æºç è§£æžå—ï¼Ÿ

é‡Œé¢çš„ size() æ–¹æ³•ä½¿ç”¨çš„æ˜¯åˆ†æ®µçš„æ€æƒ³æ¥æž„é€ çš„ï¼Œæ¯ä¸ªæ®µä½¿ç”¨çš„ç±»æ˜¯ CounterCellï¼Œå®ƒçš„ç±»ä¸Šå°±æœ‰ @sun.misc.Contended æ³¨è§£ã€‚

ä¸çŸ¥é“çš„å¯ä»¥å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€æŸ¥çœ‹åŽ†å²æ¶ˆæ¯æ‰¾åˆ°è¿™ç¯‡æ–‡ç« çœ‹çœ‹ã€‚

é™¤äº†è¿™ä¸ªç±»ï¼Œjavaä¸­è¿˜æœ‰ä¸ª LongAdder ä¹Ÿä½¿ç”¨äº†è¿™ä¸ªæ³¨è§£é¿å…ä¼ªå…±äº«ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†ä¸€èµ·å­¦ä¹  LongAdder çš„æºç åˆ†æžï¼Œæ•¬è¯·æœŸå¾…ã€‚

---

æ¬¢è¿Žå…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸Žå½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚

![qrcode](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaé›†åˆç³»åˆ—/resource/qrcode_ss.jpg)
