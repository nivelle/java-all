ğŸ–•æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚ 

---

æœ¬ç« æ¥ç€ä¸Šä¸¤ç« ï¼Œé“¾æ¥ç›´è¾¾ï¼š

[æ­»ç£• javaé›†åˆä¹‹ConcurrentHashMapæºç åˆ†æï¼ˆä¸€ï¼‰](https://mp.weixin.qq.com/s/rlyoQp4ngTX8mjGDJgJIRA)

[æ­»ç£• javaé›†åˆä¹‹ConcurrentHashMapæºç åˆ†æï¼ˆäºŒï¼‰](https://mp.weixin.qq.com/s/_Bf6XcH51lssC0mdF_oW9A)

---

### åˆ é™¤å…ƒç´ 

åˆ é™¤å…ƒç´ è·Ÿæ·»åŠ å…ƒç´ ä¸€æ ·ï¼Œéƒ½æ˜¯å…ˆæ‰¾åˆ°å…ƒç´ æ‰€åœ¨çš„æ¡¶ï¼Œç„¶åé‡‡ç”¨åˆ†æ®µé”çš„æ€æƒ³é”ä½æ•´ä¸ªæ¡¶ï¼Œå†è¿›è¡Œæ“ä½œã€‚

```java
public V remove(Object key) {
    // è°ƒç”¨æ›¿æ¢èŠ‚ç‚¹æ–¹æ³•
    return replaceNode(key, null, null);
}

final V replaceNode(Object key, V value, Object cv) {
    // è®¡ç®—hash
    int hash = spread(key.hashCode());
    // è‡ªæ—‹
    for (Node<K,V>[] tab = table;;) {
        Node<K,V> f; int n, i, fh;
        if (tab == null || (n = tab.length) == 0 ||
                (f = tabAt(tab, i = (n - 1) & hash)) == null)
            // å¦‚æœç›®æ ‡keyæ‰€åœ¨çš„æ¡¶ä¸å­˜åœ¨ï¼Œè·³å‡ºå¾ªç¯è¿”å›null
            break;
        else if ((fh = f.hash) == MOVED)
            // å¦‚æœæ­£åœ¨æ‰©å®¹ä¸­ï¼ŒååŠ©æ‰©å®¹
            tab = helpTransfer(tab, f);
        else {
            V oldVal = null;
            // æ ‡è®°æ˜¯å¦å¤„ç†è¿‡
            boolean validated = false;
            synchronized (f) {
                // å†æ¬¡éªŒè¯å½“å‰æ¡¶ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«ä¿®æ”¹è¿‡
                if (tabAt(tab, i) == f) {
                    if (fh >= 0) {
                        // fh>=0è¡¨ç¤ºæ˜¯é“¾è¡¨èŠ‚ç‚¹
                        validated = true;
                        // éå†é“¾è¡¨å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹
                        for (Node<K,V> e = f, pred = null;;) {
                            K ek;
                            if (e.hash == hash &&
                                    ((ek = e.key) == key ||
                                            (ek != null && key.equals(ek)))) {
                                // æ‰¾åˆ°äº†ç›®æ ‡èŠ‚ç‚¹
                                V ev = e.val;
                                // æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹æ—§valueæ˜¯å¦ç­‰äºcv
                                if (cv == null || cv == ev ||
                                        (ev != null && cv.equals(ev))) {
                                    oldVal = ev;
                                    if (value != null)
                                        // å¦‚æœvalueä¸ä¸ºç©ºåˆ™æ›¿æ¢æ—§å€¼
                                        e.val = value;
                                    else if (pred != null)
                                        // å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸ä¸ºç©º
                                        // åˆ é™¤å½“å‰èŠ‚ç‚¹
                                        pred.next = e.next;
                                    else
                                        // å¦‚æœå‰ç½®èŠ‚ç‚¹ä¸ºç©º
                                        // è¯´æ˜æ˜¯æ¡¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåˆ é™¤ä¹‹
                                        setTabAt(tab, i, e.next);
                                }
                                break;
                            }
                            pred = e;
                            // éå†åˆ°é“¾è¡¨å°¾éƒ¨è¿˜æ²¡æ‰¾åˆ°å…ƒç´ ï¼Œè·³å‡ºå¾ªç¯
                            if ((e = e.next) == null)
                                break;
                        }
                    }
                    else if (f instanceof TreeBin) {
                        // å¦‚æœæ˜¯æ ‘èŠ‚ç‚¹
                        validated = true;
                        TreeBin<K,V> t = (TreeBin<K,V>)f;
                        TreeNode<K,V> r, p;
                        // éå†æ ‘æ‰¾åˆ°äº†ç›®æ ‡èŠ‚ç‚¹
                        if ((r = t.root) != null &&
                                (p = r.findTreeNode(hash, key, null)) != null) {
                            V pv = p.val;
                            // æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹æ—§valueæ˜¯å¦ç­‰äºcv
                            if (cv == null || cv == pv ||
                                    (pv != null && cv.equals(pv))) {
                                oldVal = pv;
                                if (value != null)
                                    // å¦‚æœvalueä¸ä¸ºç©ºåˆ™æ›¿æ¢æ—§å€¼
                                    p.val = value;
                                else if (t.removeTreeNode(p))
                                    // å¦‚æœvalueä¸ºç©ºåˆ™åˆ é™¤å…ƒç´ 
                                    // å¦‚æœåˆ é™¤åæ ‘çš„å…ƒç´ ä¸ªæ•°è¾ƒå°‘åˆ™é€€åŒ–æˆé“¾è¡¨
                                    // t.removeTreeNode(p)è¿™ä¸ªæ–¹æ³•è¿”å›trueè¡¨ç¤ºåˆ é™¤èŠ‚ç‚¹åæ ‘çš„å…ƒç´ ä¸ªæ•°è¾ƒå°‘
                                    setTabAt(tab, i, untreeify(t.first));
                            }
                        }
                    }
                }
            }
            // å¦‚æœå¤„ç†è¿‡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ‰¾åˆ°å…ƒç´ éƒ½è¿”å›
            if (validated) {
                // å¦‚æœæ‰¾åˆ°äº†å…ƒç´ ï¼Œè¿”å›å…¶æ—§å€¼
                if (oldVal != null) {
                    // å¦‚æœè¦æ›¿æ¢çš„å€¼ä¸ºç©ºï¼Œå…ƒç´ ä¸ªæ•°å‡1
                    if (value == null)
                        addCount(-1L, -1);
                    return oldVal;
                }
                break;
            }
        }
    }
    // æ²¡æ‰¾åˆ°å…ƒç´ è¿”å›ç©º
    return null;
}
```

ï¼ˆ1ï¼‰è®¡ç®—hashï¼›

ï¼ˆ2ï¼‰å¦‚æœæ‰€åœ¨çš„æ¡¶ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å…ƒç´ ï¼Œè¿”å›ï¼›

ï¼ˆ3ï¼‰å¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œåˆ™ååŠ©æ‰©å®¹å®Œæˆåå†è¿›è¡Œåˆ é™¤æ“ä½œï¼›

ï¼ˆ4ï¼‰å¦‚æœæ˜¯ä»¥é“¾è¡¨å½¢å¼å­˜å‚¨çš„ï¼Œåˆ™éå†æ•´ä¸ªé“¾è¡¨æŸ¥æ‰¾å…ƒç´ ï¼Œæ‰¾åˆ°ä¹‹åå†åˆ é™¤ï¼›

ï¼ˆ5ï¼‰å¦‚æœæ˜¯ä»¥æ ‘å½¢å¼å­˜å‚¨çš„ï¼Œåˆ™éå†æ ‘æŸ¥æ‰¾å…ƒç´ ï¼Œæ‰¾åˆ°ä¹‹åå†åˆ é™¤ï¼›

ï¼ˆ6ï¼‰å¦‚æœæ˜¯ä»¥æ ‘å½¢å¼å­˜å‚¨çš„ï¼Œåˆ é™¤å…ƒç´ ä¹‹åæ ‘è¾ƒå°ï¼Œåˆ™é€€åŒ–æˆé“¾è¡¨ï¼›

ï¼ˆ7ï¼‰å¦‚æœç¡®å®åˆ é™¤äº†å…ƒç´ ï¼Œåˆ™æ•´ä¸ªmapå…ƒç´ ä¸ªæ•°å‡1ï¼Œå¹¶è¿”å›æ—§å€¼ï¼›

ï¼ˆ8ï¼‰å¦‚æœæ²¡æœ‰åˆ é™¤å…ƒç´ ï¼Œåˆ™è¿”å›nullï¼›

### è·å–å…ƒç´ 

è·å–å…ƒç´ ï¼Œæ ¹æ®ç›®æ ‡keyæ‰€åœ¨æ¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„ä¸åŒé‡‡ç”¨ä¸åŒçš„æ–¹å¼è·å–å…ƒç´ ï¼Œå…³é”®ç‚¹åœ¨äºfind()æ–¹æ³•çš„é‡å†™ã€‚

```java
public V get(Object key) {
    Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;
    // è®¡ç®—hash
    int h = spread(key.hashCode());
    // å¦‚æœå…ƒç´ æ‰€åœ¨çš„æ¡¶å­˜åœ¨ä¸”é‡Œé¢æœ‰å…ƒç´ 
    if ((tab = table) != null && (n = tab.length) > 0 &&
            (e = tabAt(tab, (n - 1) & h)) != null) {
        // å¦‚æœç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è¦æ‰¾çš„å…ƒç´ ï¼Œç›´æ¥è¿”å›
        if ((eh = e.hash) == h) {
            if ((ek = e.key) == key || (ek != null && key.equals(ek)))
                return e.val;
        }
        else if (eh < 0)
            // hashå°äº0ï¼Œè¯´æ˜æ˜¯æ ‘æˆ–è€…æ­£åœ¨æ‰©å®¹
            // ä½¿ç”¨findå¯»æ‰¾å…ƒç´ ï¼Œfindçš„å¯»æ‰¾æ–¹å¼ä¾æ®Nodeçš„ä¸åŒå­ç±»æœ‰ä¸åŒçš„å®ç°æ–¹å¼
            return (p = e.find(h, key)) != null ? p.val : null;

        // éå†æ•´ä¸ªé“¾è¡¨å¯»æ‰¾å…ƒç´ 
        while ((e = e.next) != null) {
            if (e.hash == h &&
                    ((ek = e.key) == key || (ek != null && key.equals(ek))))
                return e.val;
        }
    }
    return null;
}
```

ï¼ˆ1ï¼‰hashåˆ°å…ƒç´ æ‰€åœ¨çš„æ¡¶ï¼›

ï¼ˆ2ï¼‰å¦‚æœæ¡¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯è¯¥æ‰¾çš„å…ƒç´ ï¼Œç›´æ¥è¿”å›ï¼›

ï¼ˆ3ï¼‰å¦‚æœæ˜¯æ ‘æˆ–è€…æ­£åœ¨è¿ç§»å…ƒç´ ï¼Œåˆ™è°ƒç”¨å„è‡ªNodeå­ç±»çš„find()æ–¹æ³•å¯»æ‰¾å…ƒç´ ï¼›

ï¼ˆ4ï¼‰å¦‚æœæ˜¯é“¾è¡¨ï¼Œéå†æ•´ä¸ªé“¾è¡¨å¯»æ‰¾å…ƒç´ ï¼›

ï¼ˆ5ï¼‰è·å–å…ƒç´ æ²¡æœ‰åŠ é”ï¼›

### è·å–å…ƒç´ ä¸ªæ•°

å…ƒç´ ä¸ªæ•°çš„å­˜å‚¨ä¹Ÿæ˜¯é‡‡ç”¨åˆ†æ®µçš„æ€æƒ³ï¼Œè·å–å…ƒç´ ä¸ªæ•°æ—¶éœ€è¦æŠŠæ‰€æœ‰æ®µåŠ èµ·æ¥ã€‚

```java
public int size() {
    // è°ƒç”¨sumCount()è®¡ç®—å…ƒç´ ä¸ªæ•°
    long n = sumCount();
    return ((n < 0L) ? 0 :
            (n > (long)Integer.MAX_VALUE) ? Integer.MAX_VALUE :
                    (int)n);
}

final long sumCount() {
    // è®¡ç®—CounterCellæ‰€æœ‰æ®µåŠbaseCountçš„æ•°é‡ä¹‹å’Œ
    CounterCell[] as = counterCells; CounterCell a;
    long sum = baseCount;
    if (as != null) {
        for (int i = 0; i < as.length; ++i) {
            if ((a = as[i]) != null)
                sum += a.value;
        }
    }
    return sum;
}
```

ï¼ˆ1ï¼‰å…ƒç´ çš„ä¸ªæ•°ä¾æ®ä¸åŒçš„çº¿ç¨‹å­˜åœ¨åœ¨ä¸åŒçš„æ®µé‡Œï¼›ï¼ˆè§addCounter()åˆ†æï¼‰

ï¼ˆ2ï¼‰è®¡ç®—CounterCellæ‰€æœ‰æ®µåŠbaseCountçš„æ•°é‡ä¹‹å’Œï¼›

ï¼ˆ3ï¼‰è·å–å…ƒç´ ä¸ªæ•°æ²¡æœ‰åŠ é”ï¼›

## æ€»ç»“

ï¼ˆ1ï¼‰ConcurrentHashMapæ˜¯HashMapçš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼›

ï¼ˆ2ï¼‰ConcurrentHashMapé‡‡ç”¨ï¼ˆæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ï¼‰çš„ç»“æ„å­˜å‚¨å…ƒç´ ï¼›

ï¼ˆ3ï¼‰ConcurrentHashMapç›¸æ¯”äºåŒæ ·çº¿ç¨‹å®‰å…¨çš„HashTableï¼Œæ•ˆç‡è¦é«˜å¾ˆå¤šï¼›

ï¼ˆ4ï¼‰ConcurrentHashMapé‡‡ç”¨çš„é”æœ‰ synchronizedï¼ŒCASï¼Œè‡ªæ—‹é”ï¼Œåˆ†æ®µé”ï¼Œvolatileç­‰ï¼›

ï¼ˆ5ï¼‰ConcurrentHashMapä¸­æ²¡æœ‰thresholdå’ŒloadFactorè¿™ä¸¤ä¸ªå­—æ®µï¼Œè€Œæ˜¯é‡‡ç”¨sizeCtlæ¥æ§åˆ¶ï¼›

ï¼ˆ6ï¼‰sizeCtl = -1ï¼Œè¡¨ç¤ºæ­£åœ¨è¿›è¡Œåˆå§‹åŒ–ï¼›

ï¼ˆ7ï¼‰sizeCtl = 0ï¼Œé»˜è®¤å€¼ï¼Œè¡¨ç¤ºåç»­åœ¨çœŸæ­£åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨é»˜è®¤å®¹é‡ï¼›

ï¼ˆ8ï¼‰sizeCtl > 0ï¼Œåœ¨åˆå§‹åŒ–ä¹‹å‰å­˜å‚¨çš„æ˜¯ä¼ å…¥çš„å®¹é‡ï¼Œåœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹åå­˜å‚¨çš„æ˜¯ä¸‹ä¸€æ¬¡çš„æ‰©å®¹é—¨æ§›ï¼›

ï¼ˆ9ï¼‰sizeCtl = (resizeStamp << 16) + (1 + nThreads)ï¼Œè¡¨ç¤ºæ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé«˜ä½å­˜å‚¨æ‰©å®¹é‚®æˆ³ï¼Œä½ä½å­˜å‚¨æ‰©å®¹çº¿ç¨‹æ•°åŠ 1ï¼›

ï¼ˆ10ï¼‰æ›´æ–°æ“ä½œæ—¶å¦‚æœæ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œå½“å‰çº¿ç¨‹ååŠ©æ‰©å®¹ï¼›

ï¼ˆ11ï¼‰æ›´æ–°æ“ä½œä¼šé‡‡ç”¨synchronizedé”ä½å½“å‰æ¡¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ˜¯åˆ†æ®µé”çš„æ€æƒ³ï¼›

ï¼ˆ12ï¼‰æ•´ä¸ªæ‰©å®¹è¿‡ç¨‹éƒ½æ˜¯é€šè¿‡CASæ§åˆ¶sizeCtlè¿™ä¸ªå­—æ®µæ¥è¿›è¡Œçš„ï¼Œè¿™å¾ˆå…³é”®ï¼›

ï¼ˆ13ï¼‰è¿ç§»å®Œå…ƒç´ çš„æ¡¶ä¼šæ”¾ç½®ä¸€ä¸ªForwardingNodeèŠ‚ç‚¹ï¼Œä»¥æ ‡è¯†è¯¥æ¡¶è¿ç§»å®Œæ¯•ï¼›

ï¼ˆ14ï¼‰å…ƒç´ ä¸ªæ•°çš„å­˜å‚¨ä¹Ÿæ˜¯é‡‡ç”¨çš„åˆ†æ®µæ€æƒ³ï¼Œç±»ä¼¼äºLongAdderçš„å®ç°ï¼›

ï¼ˆ15ï¼‰å…ƒç´ ä¸ªæ•°çš„æ›´æ–°ä¼šæŠŠä¸åŒçš„çº¿ç¨‹hashåˆ°ä¸åŒçš„æ®µä¸Šï¼Œå‡å°‘èµ„æºäº‰ç”¨ï¼›

ï¼ˆ16ï¼‰å…ƒç´ ä¸ªæ•°çš„æ›´æ–°å¦‚æœè¿˜æ˜¯å‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°ä¸€ä¸ªæ®µï¼Œåˆ™ä¼šæ‰©å®¹æ®µï¼ˆCounterCellï¼‰ï¼›

ï¼ˆ17ï¼‰è·å–å…ƒç´ ä¸ªæ•°æ˜¯æŠŠæ‰€æœ‰çš„æ®µï¼ˆåŒ…æ‹¬baseCountå’ŒCounterCellï¼‰ç›¸åŠ èµ·æ¥å¾—åˆ°çš„ï¼›

ï¼ˆ18ï¼‰æŸ¥è¯¢æ“ä½œæ˜¯ä¸ä¼šåŠ é”çš„ï¼Œæ‰€ä»¥ConcurrentHashMapä¸æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼›

ï¼ˆ19ï¼‰ConcurrentHashMapä¸­ä¸èƒ½å­˜å‚¨keyæˆ–valueä¸ºnullçš„å…ƒç´ ï¼›

## å½©è›‹â€”â€”å€¼å¾—å­¦ä¹ çš„æŠ€æœ¯

ConcurrentHashMapä¸­æœ‰å“ªäº›å€¼å¾—å­¦ä¹ çš„æŠ€æœ¯å‘¢ï¼Ÿ

æˆ‘è®¤ä¸ºæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š

ï¼ˆ1ï¼‰CAS + è‡ªæ—‹ï¼Œä¹è§‚é”çš„æ€æƒ³ï¼Œå‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´ï¼›

ï¼ˆ2ï¼‰åˆ†æ®µé”çš„æ€æƒ³ï¼Œå‡å°‘åŒä¸€æŠŠé”äº‰ç”¨å¸¦æ¥çš„ä½æ•ˆé—®é¢˜ï¼›

ï¼ˆ3ï¼‰CounterCellï¼Œåˆ†æ®µå­˜å‚¨å…ƒç´ ä¸ªæ•°ï¼Œå‡å°‘å¤šçº¿ç¨‹åŒæ—¶æ›´æ–°ä¸€ä¸ªå­—æ®µå¸¦æ¥çš„ä½æ•ˆï¼›

ï¼ˆ4ï¼‰@sun.misc.Contendedï¼ˆCounterCellä¸Šçš„æ³¨è§£ï¼‰ï¼Œé¿å…ä¼ªå…±äº«ï¼›ï¼ˆp.s.ä¼ªå…±äº«æˆ‘ä»¬åé¢ä¹Ÿä¼šè®²çš„^^ï¼‰

ï¼ˆ5ï¼‰å¤šçº¿ç¨‹ååŒè¿›è¡Œæ‰©å®¹ï¼›

ï¼ˆ6ï¼‰ä½ åˆå­¦åˆ°äº†å“ªäº›å‘¢ï¼Ÿ

## å½©è›‹â€”â€”ä¸èƒ½è§£å†³çš„é—®é¢˜

ConcurrentHashMapä¸èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```java
private static final Map<Integer, Integer> map = new ConcurrentHashMap<>();

public void unsafeUpdate(Integer key, Integer value) {
    Integer oldValue = map.get(key);
    if (oldValue == null) {
        map.put(key, value);
    }
}
```

è¿™é‡Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨unsafeUpdate()è¿™ä¸ªæ–¹æ³•ï¼ŒConcurrentHashMapè¿˜èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸èƒ½ã€‚å› ä¸ºget()ä¹‹åifä¹‹å‰å¯èƒ½æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»put()äº†è¿™ä¸ªå…ƒç´ ï¼Œè¿™æ—¶å€™å†put()å°±æŠŠé‚£ä¸ªçº¿ç¨‹put()çš„å…ƒç´ è¦†ç›–äº†ã€‚

é‚£æ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿ

ç­”æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œä½¿ç”¨putIfAbsent()æ–¹æ³•ï¼Œå®ƒä¼šä¿è¯å…ƒç´ ä¸å­˜åœ¨æ—¶æ‰æ’å…¥å…ƒç´ ï¼Œå¦‚ä¸‹ï¼š

```java
public void safeUpdate(Integer key, Integer value) {
    map.putIfAbsent(key, value);
}
```

é‚£ä¹ˆï¼Œå¦‚æœä¸Šé¢oldValueä¸æ˜¯è·Ÿnullæ¯”è¾ƒï¼Œè€Œæ˜¯è·Ÿä¸€ä¸ªç‰¹å®šçš„å€¼æ¯”å¦‚1è¿›è¡Œæ¯”è¾ƒæ€ä¹ˆåŠï¼Ÿä¹Ÿå°±æ˜¯ä¸‹é¢è¿™æ ·ï¼š

```java
public void unsafeUpdate(Integer key, Integer value) {
    Integer oldValue = map.get(key);
    if (oldValue == 1) {
        map.put(key, value);
    }
}
```

è¿™æ ·çš„è¯å°±æ²¡åŠæ³•ä½¿ç”¨putIfAbsent()æ–¹æ³•äº†ã€‚

å…¶å®ï¼ŒConcurrentHashMapè¿˜æä¾›äº†å¦ä¸€ä¸ªæ–¹æ³•å«replace(K key, V oldValue, V newValue)å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

replace(K key, V oldValue, V newValue)è¿™ä¸ªæ–¹æ³•å¯ä¸èƒ½ä¹±ç”¨ï¼Œå¦‚æœä¼ å…¥çš„newValueæ˜¯nullï¼Œåˆ™ä¼šåˆ é™¤å…ƒç´ ã€‚

```java
public void safeUpdate(Integer key, Integer value) {
    map.replace(key, 1, value);
}
```

é‚£ä¹ˆï¼Œå¦‚æœifä¹‹åä¸æ˜¯ç®€å•çš„put()æ“ä½œï¼Œè€Œæ˜¯è¿˜æœ‰å…¶å®ƒä¸šåŠ¡æ“ä½œï¼Œä¹‹åæ‰æ˜¯put()ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼Œè¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

```java
public void unsafeUpdate(Integer key, Integer value) {
    Integer oldValue = map.get(key);
    if (oldValue == 1) {
        System.out.println(System.currentTimeMillis());
        /**
         * å…¶å®ƒä¸šåŠ¡æ“ä½œ
         */
        System.out.println(System.currentTimeMillis());
      
        map.put(key, value);
    }
}
```

è¿™æ—¶å€™å°±æ²¡åŠæ³•ä½¿ç”¨ConcurrentHashMapæä¾›çš„æ–¹æ³•äº†ï¼Œåªèƒ½ä¸šåŠ¡è‡ªå·±æ¥ä¿è¯çº¿ç¨‹å®‰å…¨äº†ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼š

```java
public void safeUpdate(Integer key, Integer value) {
    synchronized (map) {
        Integer oldValue = map.get(key);
        if (oldValue == null) {
            System.out.println(System.currentTimeMillis());
            /**
             * å…¶å®ƒä¸šåŠ¡æ“ä½œ
             */
            System.out.println(System.currentTimeMillis());

            map.put(key, value);
        }
    }
}
```

è¿™æ ·è™½ç„¶ä¸å¤ªå‹å¥½ï¼Œä½†æ˜¯æœ€èµ·ç èƒ½ä¿è¯ä¸šåŠ¡é€»è¾‘æ˜¯æ­£ç¡®çš„ã€‚

å½“ç„¶ï¼Œè¿™é‡Œä½¿ç”¨ConcurrentHashMapçš„æ„ä¹‰ä¹Ÿå°±ä¸å¤§äº†ï¼Œå¯ä»¥æ¢æˆæ™®é€šçš„HashMapäº†ã€‚

ä¸Šé¢åªæ˜¯ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬ä¸èƒ½å¬è¯´ConcurrentHashMapæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå°±è®¤ä¸ºå®ƒæ— è®ºä»€ä¹ˆæƒ…å†µä¸‹éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿˜æ˜¯é‚£å¥è¯å°½ä¿¡ä¹¦ä¸å¦‚æ— ä¹¦ã€‚

è¿™ä¹Ÿæ­£æ˜¯æˆ‘ä»¬è¯»æºç çš„ç›®çš„ä¹‹ä¸€ï¼Œäº†è§£å…¶æœ¬è´¨ï¼Œæ‰èƒ½åœ¨æˆ‘ä»¬çš„å®é™…å·¥ä½œä¸­å°‘æŒ–å‘ï¼Œä¸è®ºæ˜¯æŒ–ç»™åˆ«äººè¿˜æ˜¯æŒ–ç»™è‡ªå·±^^ã€‚

---

å¥½äº†ï¼Œæ•´ä¸ªConcurrentHashMapå°±è®²å®Œäº†ã€‚

æ–‡ç« æš‚ä¸æ”¯æŒç•™è¨€åŠŸèƒ½ï¼Œå¦‚æœæ‚¨æœ‰ä»»ä½•å»ºè®®æˆ–æ„è§è¯·åœ¨å…¬ä¼—å·åå°ç»™æˆ‘ç•™è¨€ï¼Œç•™è¨€å¿…å›å¤ã€‚

å–œæ¬¢è¿™ç¯‡å…³äºConcurrentHashMapè®²è§£çš„ï¼Œèµä¸ªé¸¡è…¿å‘—~~

---

æ¬¢è¿å…³æ³¨æˆ‘çš„å…¬ä¼—å·â€œå½¤å“¥è¯»æºç â€ï¼ŒæŸ¥çœ‹æ›´å¤šæºç ç³»åˆ—æ–‡ç« , ä¸å½¤å“¥ä¸€èµ·ç•…æ¸¸æºç çš„æµ·æ´‹ã€‚

![qrcode](https://gitee.com/alan-tang-tt/yuan/raw/master/æ­»ç£•%20javaé›†åˆç³»åˆ—/resource/qrcode_ss.jpg)
